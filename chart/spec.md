# 資産シミュレーション (Financial Asset Simulation) 仕様書

## 1. 概要
本アプリケーションは、現在の資産状況、将来の収支、投資計画、年金受給などを入力することで、将来の資産推移をシミュレーションし、グラフで可視化するWebツールです。
URLパラメータによる設定の保存・共有が可能です。

## 2. 入力項目

### 2.1 初期設定 (Initial Settings)
*   **初期現金 (万円)**: シミュレーション開始時点の手持ち現金。
*   **初期運用資産 (万円)**: シミュレーション開始時点の投資運用中の資産額。
*   **売却税率 (%)**: 運用資産を売却（現金化）する際に掛かる税率。
    *   デフォルト: 20.315%
    *   用途: 現金不足時に運用資産を取り崩す際、税金を考慮した必要売却額の計算に使用。
*   **利回り (%)**: 運用資産の想定年間リターン率。
*   **配当金 (%)**: 運用資産に対する年間の配当金率（デフォルト: 1%）。
*   **物価上昇率 (%)**: 毎年の出費増加率（デフォルト: 2%）。
*   **収入ベースアップ率 (%)**: 毎年の収入増加率（デフォルト: 0.5%）。

### 2.2 年金設定 (Pension Settings)
*   **現在の年齢**: ユーザーの現在の年齢。
*   **受給開始年齢**: 年金の受給を開始する年齢（デフォルト: 65歳）。
*   **想定年金支給年額（満額）(万円)**: 65歳受給開始時の年間支給額。
*   **調整後支給額 (自動計算)**: 受給開始年齢に応じた増減率を適用した実際の支給額。
    *   **繰り上げ受給 (<65歳)**: 1年につき -4.8% (月 -0.4%)
    *   **繰り下げ受給 (>65歳)**: 1年につき +8.4% (月 +0.7%)
*   **マクロ経済スライド調整率 (%)**: 年金支給額の物価上昇に対する調整率（デフォルト: 50%）。
    *   年金受給開始後、毎年の年金支給額を `物価上昇率 × 調整率` の割合で増額します。
    *   例: 物価上昇率2%、調整率50%の場合、年金額は毎年1%ずつ増額されます。

### 2.3 期間設定 (Period Settings)
ライフステージに合わせて、複数の期間を順次設定可能。各期間で以下のパラメータを指定する。
*   **年間収入(手取り) (万円)**: 給与などの年間純収入（期間の初年度、年金を除く）。
    *   期間内では、収入ベースアップ率に応じて毎年増加する。
    *   画面上には、参考値として「期間最終年の収入」も表示される。
*   **年間出費 (万円)**: 生活費などの年間支出（期間の初年度）。
    *   期間内では、物価上昇率に応じて毎年増加する。
    *   画面上には、参考値として「期間最終年の出費」も表示される。
*   **引き継ぎ機能**: 収入および出費について「前の期間から引き継ぐ」をチェックすると、前の期間の最終年の値をインフレ/ベースアップ調整した値が自動的に設定される。
*   **年間投資額 (万円)**: 毎年の投資積立目標額。
*   **期間 (年)**: この設定を適用する年数。

### 2.4 臨時収支 (Extra Income/Expenses)
特定の年齢で発生する一度限りの収入や支出を設定可能。
*   **年齢**: 収支が発生する年齢。
*   **金額 (万円)**: 発生する金額。正の値は収入、負の値は支出として扱われる。

## 3. 計算ロジック (詳細仕様)

シミュレーションは現在（実行時の年）から開始し、設定された期間の合計年数分だけ年次処理を行う。

### 3.1 年次処理フロー
各年において以下の順序で計算を行う。

1.  **運用資産の成長**:
    *   `運用資産 = 運用資産 × (1 + 利回り/100)`
2.  **キャッシュフロー計算**:
    *   **収入のベースアップ**: 期間内の2年目以降、`年間収入 = 前年の年間収入 × (1 + 収入ベースアップ率/100)`。
    *   **年金加算**: `現在の年齢 >= 受給開始年齢` の場合、`調整後支給額` を収入に加算。
    *   **配当金加算**: `配当金収入 = 運用資産 × (配当金/100) × (1 - 売却税率/100)` を収入に加算。
    *   **臨時収支加算**: 現在の年齢に一致する `臨時収支` がある場合、その金額を収入に加算（正なら収入、負なら支出）。
    *   **出費のインフレ**: 期間内の2年目以降、`年間出費 = 前年の年間出費 × (1 + 物価上昇率/100)`。
    *   `利用可能現金 = 現在の現金 + 年間収入 + 配当金収入 - 年間出費`
3.  **投資実行**:
    *   `利用可能現金` の範囲内で、設定された `年間投資額` を投資に回す。
    *   `実投資額 = Min(年間投資額, Max(0, 利用可能現金))`
    *   `現在の現金 = 利用可能現金 - 実投資額`
    *   `運用資産 = 運用資産 + 実投資額`
4.  **現金不足時の資産取り崩し**:
    *   `現在の現金 < 0` となった場合、不足分を補うために運用資産を売却する。
    *   売却益に対する税金を考慮し、手取りが不足分と等しくなるように売却額（グロス）を計算する。
        *   `必要売却額 = 不足額 / (1 - 売却税率/100)`
    *   `運用資産 = 運用資産 - 必要売却額`
    *   `現在の現金 = 0` (不足解消)

### 3.2 利回り変動シミュレーション
*   **トグル機能**: 利回り変動シミュレーションの有効/無効を切り替え可能。
    *   無効時: 設定された「利回り」で一定に推移。
    *   有効時: 設定された「利回り」を基準に、年ごとにランダムに変動。
*   **変動幅設定**: ランダム性の振れ幅をスライダーで設定可能（0% ～ 100%）。
    *   例: 変動幅 40% の場合、基準利回り ±40% の範囲でランダムに変動。
*   **平均回帰**: 全体を通した平均は指定の利回りになるように調整される。
*   **再計算**: 計算ボタン押下ごとにランダムな変動パターンが再生成される。

## 4. 出力・表示

### 4.1 チャート表示
Chart.js を使用した折れ線グラフ/面グラフ。
*   **X軸**: 西暦 (年)
*   **Y軸 (左)**: 資産額 (万円単位、"K"表記で千万円単位)
*   **Y軸 (右)**: 年間利回り (%) - シミュレーション有効時のみ表示
*   **チャート表示**:
    *   **総資産**: 積み上げ面グラフ（青色）。
    *   **運用資産**: 点線（緑色）。
    *   **現金**: 点線（黄色）。
    *   **年間利回り**: 棒グラフ（右軸、灰色）。
    *   **平均利回り**: 点線（右軸、赤色）。シミュレーション結果の各年までの単純平均利回りを表示。
    *   **期間境界**: 期間の変わり目に縦線とラベルを表示。

### 4.2 UI機能
*   **URL共有**: 入力値が変更されるたびにURLクエリパラメータ (`?cap=...&p=...`) が更新され、ブックマークや共有が可能。
*   **折りたたみ**: 初期設定・年金設定セクションは折りたたみ可能。
*   **チャート調整**:
    *   **高さ調整**: スライダーによる高さ調整（画面高さの1/3 ～ 100%の範囲）。ドラッグハンドルでも調整可能。
    *   **利回り変動幅**: スライダーで利回りシミュレーションの変動幅を調整可能。
*   **仕様詳細表示**: 「仕様詳細を表示」ボタンで、この仕様書 (`spec.md`) の内容を表示可能。

## 5. 技術スタック
*   HTML5 / CSS3
*   JavaScript (Vanilla ES6+)
*   ライブラリ: Chart.js (CDN)
*   フォント: Google Fonts (Inter)

