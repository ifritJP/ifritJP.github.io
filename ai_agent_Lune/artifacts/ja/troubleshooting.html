<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuneScript 入門 - トラブルシューティング</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4708B8S6ES"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-4708B8S6ES');
</script>
</head>

<body>
    <div class="sidebar">
        <h1>LuneScript Guide</h1>
        <ul class="nav-links">
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="index.html">はじめに</a>
                <ul class="submenu">
                    <li><a href="index.html#features">主な特徴</a></li>
                    <li><a href="index.html#audience">対象読者</a></li>
                    <li><a href="index.html#license">ライセンス</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="learning.html">学習ガイド</a>
                <ul class="submenu">
                    <li><a href="learning.html#step1">ステップ1: 基礎</a></li>
                    <li><a href="learning.html#step2">ステップ2: 安全機能</a></li>
                    <li><a href="learning.html#step3">ステップ3: モダン機能</a></li>
                    <li><a href="learning.html#navigation">ドキュメント活用</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial.html">導入とHello World</a>
                <ul class="submenu">
                    <li><a href="tutorial.html#install">導入</a></li>
                    <li><a href="tutorial.html#hello">Hello World</a></li>
                    <li><a href="tutorial.html#options">lnsc コマンド</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="syntax.html">基本構文</a>
                <ul class="submenu">
                    <li><a href="syntax.html#comments">コメント</a></li>
                    <li><a href="syntax.html#vars">変数宣言</a></li>
                    <li><a href="syntax.html#flow">フロー解析による初期化</a></li>
                    <li><a href="syntax.html#scope">スコープブロック</a></li>
                    <li><a href="syntax.html#attr">属性</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="value.html">値と型</a>
                <ul class="submenu">
                    <li><a href="value.html#primitive">プリミティブ型</a></li>
                    <li><a href="value.html#collection">コレクション</a></li>
                    <li><a href="value.html#list">&nbsp;&nbsp;List</a></li>
                    <li><a href="value.html#map">&nbsp;&nbsp;Map</a></li>
                    <li><a href="value.html#set">&nbsp;&nbsp;Set</a></li>
                    <li><a href="value.html#nilable">Nilable 型</a></li>
                    <li><a href="value.html#cast">キャスト</a></li>
                    <li><a href="value.html#alge">Algebric Data Type</a></li>
                    <li><a href="value.html#enum">Enum</a></li>
                    <li><a href="value.html#tuple">Tuple</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="control.html">制御構文</a>
                <ul class="submenu">
                    <li><a href="control.html#if">if 文</a></li>
                    <li><a href="control.html#switch">switch 文</a></li>
                    <li><a href="control.html#while">while 文</a></li>
                    <li><a href="control.html#repeat">repeat 文</a></li>
                    <li><a href="control.html#for">for 文</a></li>
                    <li><a href="control.html#foreach">foreach 文</a></li>
                    <li><a href="control.html#apply">apply 文</a></li>
                    <li><a href="control.html#match">match 文</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="error.html">エラーハンドリング</a>
                <ul class="submenu">
                    <li><a href="error.html#ret">__Ret 型</a></li>
                    <li><a href="error.html#delegation">エラーの委譲</a></li>
                    <li><a href="error.html#best_practice">型と使い分け</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="function.html">関数</a>
                <ul class="submenu">
                    <li><a href="function.html#def">定義</a></li>
                    <li><a href="function.html#multi_ret">多値返却</a></li>
                    <li><a href="function.html#closure">クロージャ</a></li>
                    <li><a href="function.html#form">Form (関数型)</a></li>
                    <li><a href="function.html#varargs">可変長引数</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="class.html">クラス</a>
                <ul class="submenu">
                    <li><a href="class.html#def">定義とインスタンス化</a></li>
                    <li><a href="class.html#inherit">継承とオーバーライド</a></li>
                    <li><a href="class.html#abstract">抽象クラス</a></li>
                    <li><a href="class.html#interface">インタフェース</a></li>
                    <li><a href="class.html#advertise">Advertise</a></li>
                    <li><a href="class.html#mapping">Mapping</a></li>
                    <li><a href="class.html#proto">プロトタイプ宣言</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="generics.html">Generics</a>
                <ul class="submenu">
                    <li><a href="generics.html#func">関数の Generics</a></li>
                    <li><a href="generics.html#class">クラスの Generics</a></li>
                    <li><a href="generics.html#constraint">型パラメータの制約</a></li>
                    <li><a href="generics.html#method">メソッドの Generics</a></li>
                    <li><a href="generics.html#mut">Generics と Mutability</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="macro.html">マクロ</a>
                <ul class="submenu">
                    <li><a href="macro.html#def">定義</a></li>
                    <li><a href="macro.html#arg">引数</a></li>
                    <li><a href="macro.html#quote">Quoting</a></li>
                    <li><a href="macro.html#statement">Macro Statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="advanced.html">高度な機能</a>
                <ul class="submenu">
                    <li><a href="advanced.html#match">パターンマッチ</a></li>
                    <li><a href="advanced.html#async">非同期処理</a></li>
                    <li><a href="advanced.html#glue">Glue コード</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="module.html">モジュールとプロジェクト</a>
                <ul class="submenu">
                    <li><a href="module.html#module">モジュールシステム</a></li>
                    <li><a href="module.html#project">プロジェクト設定</a></li>
                    <li><a href="module.html#provide">Provide</a></li>
                    <li><a href="module.html#require">Require</a></li>
                    <li><a href="module.html#subfile">Subfile</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="standard.html">標準ライブラリ</a>
                <ul class="submenu">
                    <li><a href="standard.html#builtin">ビルトイン関数</a></li>
                    <li><a href="standard.html#lua">Lua 標準ライブラリ</a></li>
                    <li><a href="standard.html#io">IO</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_macro.html">実践: マクロ活用</a>
                <ul class="submenu">
                    <li><a href="tutorial_macro.html#step1">Step 1: デバッグプリント</a></li>
                    <li><a href="tutorial_macro.html#step2">Step 2: アサーション</a></li>
                    <li><a href="tutorial_macro.html#step3">Step 3: 計測</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_parser.html">実践: 数式パーサ</a>
                <ul class="submenu">
                    <li><a href="tutorial_parser.html#goal">目標</a></li>
                    <li><a href="tutorial_parser.html#token">Step 1: トークン定義</a></li>
                    <li><a href="tutorial_parser.html#lexer">Step 2: 字句解析</a></li>
                    <li><a href="tutorial_parser.html#ast">Step 3: 構文木 (AST)</a></li>
                    <li><a href="tutorial_parser.html#parser">Step 4: 構文解析</a></li>
                    <li><a href="tutorial_parser.html#eval">Step 5: 評価と実行</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="keyword.html">キーワード一覧</a>
                <ul class="submenu">
                    <li><a href="keyword.html#a">A-G</a></li>
                    <li><a href="keyword.html#h">H-N</a></li>
                    <li><a href="keyword.html#o">O-U</a></li>
                    <li><a href="keyword.html#v">V-Z</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="troubleshooting.html">トラブルシューティング</a>
                <ul class="submenu">
                    <li><a href="troubleshooting.html#char">文字リテラル</a></li>
                    <li><a href="troubleshooting.html#mut">ミュータブルなメソッド</a></li>
                    <li><a href="troubleshooting.html#match">パターンマッチ</a></li>
                    <li><a href="troubleshooting.html#unwrap">Nilable 型の操作</a></li>
                    <li><a href="troubleshooting.html#macro">マクロの構文エラー</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="evaluation.html">考察と評価</a>
                <ul class="submenu">
                    <li><a href="evaluation.html#quality">言語の出来</a></li>
                    <li><a href="evaluation.html#vs-lua">Luaとの比較</a></li>
                    <li><a href="evaluation.html#vs-teal">Tealとの比較</a></li>
                    <li><a href="evaluation.html#issues">課題と提案</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="main-content">
    <div class="header-nav">
        <a href="../en/troubleshooting.html" class="lang-link">English</a>
    </div>
        <h1>トラブルシューティング & よくある間違い</h1>
        <p>LuneScript の学習中に遭遇しやすいエラーとその解決方法をまとめました。<br>
            他の言語（特に Lua, Go, Rust など）の経験者がハマりやすいポイントを中心に解説します。</p>

        <h2 id="char">文字リテラルの構文</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: シングルクォートを使ってしまう</p>
                <pre><code class="language-lns">// @lnsFront: skip

let c = 'a';    // Error
let c = ?'a';   // Error
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: <code>?</code> の直後に文字を書く</p>
                <pre><code class="language-lns">// @lnsFront: skip

let c = ?a;     // 文字コード (int) になる
let sp = ? ;    // スペースの場合も同様
let zero = ?0;  // 数字の文字コード
                </code></pre>
                <p>LuneScript では、文字リテラルは整数値（文字コード）として扱われます。</p>
            </div>
        </div>

        <h2 id="mut">ミュータブルなメソッド定義</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: <code>mut</code> を前置してしまう</p>
                <pre><code class="language-lns">// @lnsFront: skip

class MyClass {
    let mut val: int;
    // Error: illegal field or method declaration
    pub mut fn inc() {
        self.val = self.val + 1;
    }
}
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: <code>mut</code> は引数リストの後ろに置く</p>
                <pre><code class="language-lns">// @lnsFront: skip

class MyClass {
    let mut val: int;
    // メソッドが自身 (self) を書き換えることを示す
    pub fn inc() mut {
        self.val = self.val + 1;
    }
}
                </code></pre>
                <p>メソッド定義において、<code>mut</code> は「このメソッドは <code>self</code>
                    を変更する」という副作用の宣言として機能するため、シグネチャの一部（後ろ側）に記述します。<br>
                    なお、戻り値がある場合は <code>pun fn func() mut : int</code> のように戻り値の型の前になります。</p>
            </div>
        </div>

        <h2 id="match">ADT のパターンマッチ</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: <code>if let</code> を使おうとする (Rust風)</p>
                <pre><code class="language-lns">// @lnsFront: skip

// Error: illegal exp
if let .Val( v ) = val {
    print( v );
}
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: <code>match</code> 文を使用する</p>
                <pre><code class="language-lns">// @lnsFront: skip

match val {
    case .Val( v ) {
        print( v );
    }
    default {
        // マッチしなかった場合の処理
    }
}
                </code></pre>
                <p>LuneScript の現行バージョンでは、代数的データ型 (Algebric Data Type) の分解には <code>match</code> 文を使用するのが基本です。</p>
            </div>
        </div>

        <h2 id="unwrap">Nilable 型の操作と unwrap</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: Nilable 型をそのまま非 Nilable として扱う</p>
                <pre><code class="language-lns">// @lnsFront: skip

let val: int! = 10;
// Error: type mismatch int! (nilable) to int
let num: int = val; 
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: <code>unwrap</code> を使って安全に取り出す</p>
                <pre><code class="language-lns">// @lnsFront: skip

let val: int! = 10;
// nil だった場合のデフォルト値を指定する
let num: int = unwrap val default 0;

// または if let で絞り込む
if let v = val {
    print( v ); // ここでは v は int 型
}
                </code></pre>
                <p><code>unwrap</code> は「値が nil でないことを保証する」か「nil の場合の代替値を提供する」ために使われます。</p>
            </div>
        </div>

        <h2 id="macro">マクロの構文エラー</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: 展開演算子 <code>,,</code> を忘れる</p>
                <pre><code class="language-lns">// @lnsFront: skip
macro _dprint( val: __exp ) {
    print( val ); // Error: val は __exp 型であり、そのままでは使えない
}
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: <code>,,</code> を使って式を展開する</p>
                <pre><code class="language-lns">// @lnsFront: skip
macro _dprint( val: __exp ) {
    print( ,,val ); // OK: 式が展開される
}
                </code></pre>
                <p>マクロ引数（<code>__exp</code>, <code>sym</code>, <code>__block</code> など）をコード内で利用するには、必ず <code>,,</code>
                    で展開する必要があります。</p>
            </div>
        </div>

        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: Lua の予約語をシンボル名に使ってしまう</p>
                <pre><code class="language-lns">// @lnsFront: skip
macro _measure( block: __block ) {
    {}
    {
        let start = os.clock();
        ,,block
        let end = os.clock(); // Error: 'end' は Lua の予約語
        print( end - start );
    }
}
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: 予約語を避けた名前にする</p>
                <p>LuneScript は Lua に変換されるため、マクロで展開されるコード内の変数名が Lua の予約語（<code>end</code>, <code>function</code>,
                    <code>repeat</code> など）と衝突するとエラーになります。<code>endTime</code> などの別の名前に変更してください。</p>
            </div>
        </div>

        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: <code>__block</code> 引数に直接ステートメントを書く</p>
                <pre><code class="language-lns">// @lnsFront: skip
_measure( print("hello") ); // Error: 式ではなくブロック {} が必要
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: <code>{}</code> で囲って渡す</p>
                <pre><code class="language-lns">// @lnsFront: skip
_measure( { print("hello"); } );
                </code></pre>
                <p>また、LuneScript の最新の文法では <code>__block</code> の代わりに <code>##</code>
                    を使った引数省略機能の利用が推奨される場合があります。コンパイラの警告に従って調整してください。</p>
            </div>
        </div>

        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: <code>macro-statement</code> 内で通常の関数を定義・呼び出ししようとする</p>
                <pre><code class="language-lns">// @lnsFront: skip
macro _Test() {
  {
    fn createFunc( name: str ): stat { // Error
       return `{ fn ,,,name() {} };
    }
  }
  ,,createFunc("hoge");
}
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: <code>macro-statement</code> は制限された環境であることを理解する</p>
                <p><code>macro-statement</code> ブロック内では、型システムやユーザー定義関数が完全に利用できるわけではありません。基本的には、組込み型と組込み関数を用いた計算、および
                    <code>`{}</code> によるコード生成に専念させるのが安全です。</p>
            </div>
        </div>

        <div class="trouble-box">
            <div class="error-case">
                <p>間違い: <code>,,,</code> 演算子の範囲が不明確</p>
                <pre><code class="language-lns">// @lnsFront: skip
stats.insert( `{
    let ,,, "v_%s"(name) = ,,i; // Error: どこまでが名前生成式か不明
} );
                </code></pre>
            </div>
            <div class="solution">
                <p>正解: <code>~~</code> で終端を明示する</p>
                <pre><code class="language-lns">// @lnsFront: skip
stats.insert( `{
    let ,,, "v_%s"(name) ~~ = ,,i; // OK: ~~ で式の終わりを教える
} );
                </code></pre>
                <p>シンボルを動的に生成する <code>,,,</code> 演算子は、その後に続く要素と結合して解釈されるのを防ぐため、<code>~~</code> による区切りが必要になるケースが多々あります。
                </p>
            </div>
        </div>


    </div>
</body>

</html>