<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuneScript 入門 - マクロ</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
</head>

<body>
    <div class="sidebar">
        <h1>LuneScript Guide</h1>
        <ul class="nav-links">
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="index.html">はじめに</a>
                <ul class="submenu">
                    <li><a href="index.html#features">主な特徴</a></li>
                    <li><a href="index.html#audience">対象読者</a></li>
                    <li><a href="index.html#license">ライセンス</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="learning.html">学習ガイド</a>
                <ul class="submenu">
                    <li><a href="learning.html#step1">ステップ1: 基礎</a></li>
                    <li><a href="learning.html#step2">ステップ2: 安全機能</a></li>
                    <li><a href="learning.html#step3">ステップ3: モダン機能</a></li>
                    <li><a href="learning.html#navigation">ドキュメント活用</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial.html">導入とHello World</a>
                <ul class="submenu">
                    <li><a href="tutorial.html#install">導入</a></li>
                    <li><a href="tutorial.html#hello">Hello World</a></li>
                    <li><a href="tutorial.html#options">lnsc コマンド</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="syntax.html">基本構文</a>
                <ul class="submenu">
                    <li><a href="syntax.html#comments">コメント</a></li>
                    <li><a href="syntax.html#vars">変数宣言</a></li>
                    <li><a href="syntax.html#flow">フロー解析による初期化</a></li>
                    <li><a href="syntax.html#scope">スコープブロック</a></li>
                    <li><a href="syntax.html#attr">属性</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="value.html">値と型</a>
                <ul class="submenu">
                    <li><a href="value.html#primitive">プリミティブ型</a></li>
                    <li><a href="value.html#collection">コレクション</a></li>
                    <li><a href="value.html#list">&nbsp;&nbsp;List</a></li>
                    <li><a href="value.html#map">&nbsp;&nbsp;Map</a></li>
                    <li><a href="value.html#set">&nbsp;&nbsp;Set</a></li>
                    <li><a href="value.html#nilable">Nilable 型</a></li>
                    <li><a href="value.html#cast">キャスト</a></li>
                    <li><a href="value.html#alge">Algebric Data Type</a></li>
                    <li><a href="value.html#enum">Enum</a></li>
                    <li><a href="value.html#tuple">Tuple</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="control.html">制御構文</a>
                <ul class="submenu">
                    <li><a href="control.html#if">if 文</a></li>
                    <li><a href="control.html#switch">switch 文</a></li>
                    <li><a href="control.html#while">while 文</a></li>
                    <li><a href="control.html#repeat">repeat 文</a></li>
                    <li><a href="control.html#for">for 文</a></li>
                    <li><a href="control.html#foreach">foreach 文</a></li>
                    <li><a href="control.html#apply">apply 文</a></li>
                    <li><a href="control.html#match">match 文</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="error.html">エラーハンドリング</a>
                <ul class="submenu">
                    <li><a href="error.html#ret">__Ret 型</a></li>
                    <li><a href="error.html#delegation">エラーの委譲</a></li>
                    <li><a href="error.html#best_practice">型と使い分け</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="function.html">関数</a>
                <ul class="submenu">
                    <li><a href="function.html#def">定義</a></li>
                    <li><a href="function.html#multi_ret">多値返却</a></li>
                    <li><a href="function.html#closure">クロージャ</a></li>
                    <li><a href="function.html#form">Form (関数型)</a></li>
                    <li><a href="function.html#varargs">可変長引数</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="class.html">クラス</a>
                <ul class="submenu">
                    <li><a href="class.html#def">定義とインスタンス化</a></li>
                    <li><a href="class.html#inherit">継承とオーバーライド</a></li>
                    <li><a href="class.html#abstract">抽象クラス</a></li>
                    <li><a href="class.html#interface">インタフェース</a></li>
                    <li><a href="class.html#advertise">Advertise</a></li>
                    <li><a href="class.html#mapping">Mapping</a></li>
                    <li><a href="class.html#proto">プロトタイプ宣言</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="generics.html">Generics</a>
                <ul class="submenu">
                    <li><a href="generics.html#func">関数の Generics</a></li>
                    <li><a href="generics.html#class">クラスの Generics</a></li>
                    <li><a href="generics.html#constraint">型パラメータの制約</a></li>
                    <li><a href="generics.html#method">メソッドの Generics</a></li>
                    <li><a href="generics.html#mut">Generics と Mutability</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="macro.html">マクロ</a>
                <ul class="submenu">
                    <li><a href="macro.html#def">定義</a></li>
                    <li><a href="macro.html#arg">引数</a></li>
                    <li><a href="macro.html#quote">Quoting</a></li>
                    <li><a href="macro.html#statement">Macro Statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="advanced.html">高度な機能</a>
                <ul class="submenu">
                    <li><a href="advanced.html#match">パターンマッチ</a></li>
                    <li><a href="advanced.html#async">非同期処理</a></li>
                    <li><a href="advanced.html#glue">Glue コード</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="module.html">モジュールとプロジェクト</a>
                <ul class="submenu">
                    <li><a href="module.html#module">モジュールシステム</a></li>
                    <li><a href="module.html#project">プロジェクト設定</a></li>
                    <li><a href="module.html#provide">Provide</a></li>
                    <li><a href="module.html#require">Require</a></li>
                    <li><a href="module.html#subfile">Subfile</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="standard.html">標準ライブラリ</a>
                <ul class="submenu">
                    <li><a href="standard.html#builtin">ビルトイン関数</a></li>
                    <li><a href="standard.html#lua">Lua 標準ライブラリ</a></li>
                    <li><a href="standard.html#io">IO</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_macro.html">実践: マクロ活用</a>
                <ul class="submenu">
                    <li><a href="tutorial_macro.html#step1">Step 1: デバッグプリント</a></li>
                    <li><a href="tutorial_macro.html#step2">Step 2: アサーション</a></li>
                    <li><a href="tutorial_macro.html#step3">Step 3: 計測</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_parser.html">実践: 数式パーサ</a>
                <ul class="submenu">
                    <li><a href="tutorial_parser.html#goal">目標</a></li>
                    <li><a href="tutorial_parser.html#token">Step 1: トークン定義</a></li>
                    <li><a href="tutorial_parser.html#lexer">Step 2: 字句解析</a></li>
                    <li><a href="tutorial_parser.html#ast">Step 3: 構文木 (AST)</a></li>
                    <li><a href="tutorial_parser.html#parser">Step 4: 構文解析</a></li>
                    <li><a href="tutorial_parser.html#eval">Step 5: 評価と実行</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="keyword.html">キーワード一覧</a>
                <ul class="submenu">
                    <li><a href="keyword.html#a">A-G</a></li>
                    <li><a href="keyword.html#h">H-N</a></li>
                    <li><a href="keyword.html#o">O-U</a></li>
                    <li><a href="keyword.html#v">V-Z</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="troubleshooting.html">トラブルシューティング</a>
                <ul class="submenu">
                    <li><a href="troubleshooting.html#char">文字リテラル</a></li>
                    <li><a href="troubleshooting.html#mut">ミュータブルなメソッド</a></li>
                    <li><a href="troubleshooting.html#match">パターンマッチ</a></li>
                    <li><a href="troubleshooting.html#unwrap">Nilable 型の操作</a></li>
                    <li><a href="troubleshooting.html#macro">マクロの構文エラー</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="evaluation.html">考察と評価</a>
                <ul class="submenu">
                    <li><a href="evaluation.html#quality">言語の出来</a></li>
                    <li><a href="evaluation.html#vs-lua">Luaとの比較</a></li>
                    <li><a href="evaluation.html#vs-teal">Tealとの比較</a></li>
                    <li><a href="evaluation.html#issues">課題と提案</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="main-content">
    <div class="header-nav">
        <a href="../en/macro.html" class="lang-link">English</a>
    </div>
        <h1>マクロ</h1>
        <p>LuneScript のマクロは、コンパイル時にコード（AST）を展開・生成する強力な機能です。</p>

        <h2 id="def">定義</h2>
        <p><code>macro</code> キーワードを使用して定義します。マクロ名は慣習としてアンダースコア <code>_</code> で始めます。</p>
        <pre><code class="language-lns"><span class="keyword">macro</span> _dprint( exp: __exp ) {
    print( <span class="string">"DEBUG:"</span>, ,,exp );
}
</code></pre>

        <h2 id="arg">引数</h2>
        <p>マクロの引数には、通常の型の他に、マクロ専用の型を指定できます。</p>
        <ul>
            <li><code>__exp</code>: 式そのものを受け取ります。最も汎用的な型です。</li>
            <li><code>sym</code>: シンボル（変数名や関数名など）を受け取ります。</li>
            <li><code>__block</code>: コードブロック <code>{ ... }</code> を受け取ります。</li>
        </ul>
        <pre><code class="language-lns"><span class="keyword">macro</span> _assign( symbol: sym, val: <span class="type">int</span> ) {
    ,,symbol = ,,val;
}
<span class="keyword">let</span> <span class="keyword">mut</span> val = <span class="number">0</span>;
_assign( val, <span class="number">10</span> ); <span class="comment">// val = 10; と展開される</span>
</code></pre>

        <h2 id="quote">Quoting (展開演算子)</h2>
        <p>マクロ本体（expand-statement）で引数を使用する場合、以下の演算子を使用して展開を制御します。</p>
        <table>
            <thead>
                <tr>
                    <th>演算子</th>
                    <th>説明</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>,,</code></td>
                    <td>引数の値をそのままコードとして展開します。</td>
                </tr>
                <tr>
                    <td><code>,,,</code></td>
                    <td>引数の文字列値を<strong>シンボル名</strong>として展開します。</td>
                </tr>
                <tr>
                    <td><code>,,,,</code></td>
                    <td>引数のシンボル名を<strong>文字列リテラル</strong>に変換して展開します。</td>
                </tr>
            </tbody>
        </table>

        <pre><code class="language-lns"><span class="keyword">pub</span> <span class="keyword">macro</span> _hello( name: <span class="type">str</span> ) {
    print( <span class="string">"Hello, "</span>, ,,name );
}
</code></pre>

        <h2 id="statement">Macro Statement</h2>
        <p>マクロ定義は、計算や準備を行う <code>macro-statement</code>（最初の <code>{}</code>）と、実際にコードを生成する
            <code>expand-statement</code>（後半部分）で構成されます。
        </p>
        <p><code>macro-statement</code> 内では、LuneScript の標準的な計算機能が利用でき、動的に展開するコードの内容を決定できます。さらに <code>`{}</code>
            演算子を使用することで、コードの断片（<code>stat</code> 型）を変数に格納してリスト化することも可能です。</p>

        <h3>動的なコード生成の例</h3>
        <p>以下の例では、指定された数だけ一連の変数を自動定義します。</p>
        <pre><code class="language-lns"><span class="keyword">macro</span> _GenVars( prefix: <span class="type">str</span>, count: <span class="type">int</span> ) {
    {
        <span class="comment">// macro-statement: 展開するコードのリストを作成</span>
        <span class="keyword">let</span> <span class="keyword">mut</span> stats: <span class="type">List&lt;stat&gt;</span> = [];
        <span class="keyword">for</span> i = <span class="number">1</span>, count {
            <span class="keyword">let</span> varName = <span class="string">"%s%d"</span> (prefix, i);
            stats.insert( <span class="keyword">`{</span>
                <span class="keyword">let</span> <span class="keyword">,,,</span><span class="string">"v_%s"</span>(varName)~~ = <span class="keyword">,,</span>i;
            <span class="keyword">}</span> );
        }
    }
    <span class="comment">// expand-statement: 生成したリストを一気に展開</span>
    <span class="keyword">,,</span>stats;
}

_GenVars( <span class="string">"val"</span>, <span class="number">3</span> );
<span class="comment">// let v_val1 = 1; let v_val2 = 2; let v_val3 = 3; と展開される</span>
print( v_val1, v_val2, v_val3 ); <span class="comment">// 1 2 3</span>
</code></pre>

        <div class="note">
            <h4>macro-statement 内での制約</h4>
            <ul>
                <li>利用可能な関数は LuneScript の標準関数（<code>print</code>, <code>os.clock</code>, <code>io.open</code> など）のみです。
                </li>
                <li>同じファイル内で定義された通常の関数を呼び出すことはできません（コンパイル時にはまだその関数は存在しないためです）。</li>
                <li>特殊な演算子 <code>~~</code> は、<code>,,,</code> 演算子が対象とする式の終わりを明示するために使用します。</li>
            </ul>
        </div>


        <div class="note">
            <h4>注意: Lua 予約語との衝突</h4>
            マクロで展開されるコード内の変数名が Lua の予約語（<code>end</code> など）と衝突すると、トランスコンパイル後にエラーとなります。マクロ内部で使用する変数名には注意してください。
        </div>

        <div class="note">
            マクロは複雑な機能であり、乱用するとコードの可読性を損なう可能性があります。適切に使用してください。
        </div>

    </div>
</body>

</html>