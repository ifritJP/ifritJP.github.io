<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuneScript 入門 - 関数</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
</head>

<body>
    <div class="sidebar">
        <h1>LuneScript Guide</h1>
        <ul class="nav-links">
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="index.html">はじめに</a>
                <ul class="submenu">
                    <li><a href="index.html#features">主な特徴</a></li>
                    <li><a href="index.html#audience">対象読者</a></li>
                    <li><a href="index.html#license">ライセンス</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="learning.html">学習ガイド</a>
                <ul class="submenu">
                    <li><a href="learning.html#step1">ステップ1: 基礎</a></li>
                    <li><a href="learning.html#step2">ステップ2: 安全機能</a></li>
                    <li><a href="learning.html#step3">ステップ3: モダン機能</a></li>
                    <li><a href="learning.html#navigation">ドキュメント活用</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial.html">導入とHello World</a>
                <ul class="submenu">
                    <li><a href="tutorial.html#install">導入</a></li>
                    <li><a href="tutorial.html#hello">Hello World</a></li>
                    <li><a href="tutorial.html#options">lnsc コマンド</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="syntax.html">基本構文</a>
                <ul class="submenu">
                    <li><a href="syntax.html#comments">コメント</a></li>
                    <li><a href="syntax.html#vars">変数宣言</a></li>
                    <li><a href="syntax.html#flow">フロー解析による初期化</a></li>
                    <li><a href="syntax.html#scope">スコープブロック</a></li>
                    <li><a href="syntax.html#attr">属性</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="value.html">値と型</a>
                <ul class="submenu">
                    <li><a href="value.html#primitive">プリミティブ型</a></li>
                    <li><a href="value.html#collection">コレクション</a></li>
                    <li><a href="value.html#list">&nbsp;&nbsp;List</a></li>
                    <li><a href="value.html#map">&nbsp;&nbsp;Map</a></li>
                    <li><a href="value.html#set">&nbsp;&nbsp;Set</a></li>
                    <li><a href="value.html#nilable">Nilable 型</a></li>
                    <li><a href="value.html#cast">キャスト</a></li>
                    <li><a href="value.html#alge">Algebric Data Type</a></li>
                    <li><a href="value.html#enum">Enum</a></li>
                    <li><a href="value.html#tuple">Tuple</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="control.html">制御構文</a>
                <ul class="submenu">
                    <li><a href="control.html#if">if 文</a></li>
                    <li><a href="control.html#switch">switch 文</a></li>
                    <li><a href="control.html#while">while 文</a></li>
                    <li><a href="control.html#repeat">repeat 文</a></li>
                    <li><a href="control.html#for">for 文</a></li>
                    <li><a href="control.html#foreach">foreach 文</a></li>
                    <li><a href="control.html#apply">apply 文</a></li>
                    <li><a href="control.html#match">match 文</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="error.html">エラーハンドリング</a>
                <ul class="submenu">
                    <li><a href="error.html#ret">__Ret 型</a></li>
                    <li><a href="error.html#delegation">エラーの委譲</a></li>
                    <li><a href="error.html#best_practice">型と使い分け</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="function.html">関数</a>
                <ul class="submenu">
                    <li><a href="function.html#def">定義</a></li>
                    <li><a href="function.html#multi_ret">多値返却</a></li>
                    <li><a href="function.html#closure">クロージャ</a></li>
                    <li><a href="function.html#form">Form (関数型)</a></li>
                    <li><a href="function.html#varargs">可変長引数</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="class.html">クラス</a>
                <ul class="submenu">
                    <li><a href="class.html#def">定義とインスタンス化</a></li>
                    <li><a href="class.html#inherit">継承とオーバーライド</a></li>
                    <li><a href="class.html#abstract">抽象クラス</a></li>
                    <li><a href="class.html#interface">インタフェース</a></li>
                    <li><a href="class.html#advertise">Advertise</a></li>
                    <li><a href="class.html#mapping">Mapping</a></li>
                    <li><a href="class.html#proto">プロトタイプ宣言</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="generics.html">Generics</a>
                <ul class="submenu">
                    <li><a href="generics.html#func">関数の Generics</a></li>
                    <li><a href="generics.html#class">クラスの Generics</a></li>
                    <li><a href="generics.html#constraint">型パラメータの制約</a></li>
                    <li><a href="generics.html#method">メソッドの Generics</a></li>
                    <li><a href="generics.html#mut">Generics と Mutability</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="macro.html">マクロ</a>
                <ul class="submenu">
                    <li><a href="macro.html#def">定義</a></li>
                    <li><a href="macro.html#arg">引数</a></li>
                    <li><a href="macro.html#quote">Quoting</a></li>
                    <li><a href="macro.html#statement">Macro Statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="advanced.html">高度な機能</a>
                <ul class="submenu">
                    <li><a href="advanced.html#match">パターンマッチ</a></li>
                    <li><a href="advanced.html#async">非同期処理</a></li>
                    <li><a href="advanced.html#glue">Glue コード</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="module.html">モジュールとプロジェクト</a>
                <ul class="submenu">
                    <li><a href="module.html#module">モジュールシステム</a></li>
                    <li><a href="module.html#project">プロジェクト設定</a></li>
                    <li><a href="module.html#provide">Provide</a></li>
                    <li><a href="module.html#require">Require</a></li>
                    <li><a href="module.html#subfile">Subfile</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="standard.html">標準ライブラリ</a>
                <ul class="submenu">
                    <li><a href="standard.html#builtin">ビルトイン関数</a></li>
                    <li><a href="standard.html#lua">Lua 標準ライブラリ</a></li>
                    <li><a href="standard.html#io">IO</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_macro.html">実践: マクロ活用</a>
                <ul class="submenu">
                    <li><a href="tutorial_macro.html#step1">Step 1: デバッグプリント</a></li>
                    <li><a href="tutorial_macro.html#step2">Step 2: アサーション</a></li>
                    <li><a href="tutorial_macro.html#step3">Step 3: 計測</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_parser.html">実践: 数式パーサ</a>
                <ul class="submenu">
                    <li><a href="tutorial_parser.html#goal">目標</a></li>
                    <li><a href="tutorial_parser.html#token">Step 1: トークン定義</a></li>
                    <li><a href="tutorial_parser.html#lexer">Step 2: 字句解析</a></li>
                    <li><a href="tutorial_parser.html#ast">Step 3: 構文木 (AST)</a></li>
                    <li><a href="tutorial_parser.html#parser">Step 4: 構文解析</a></li>
                    <li><a href="tutorial_parser.html#eval">Step 5: 評価と実行</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="keyword.html">キーワード一覧</a>
                <ul class="submenu">
                    <li><a href="keyword.html#a">A-G</a></li>
                    <li><a href="keyword.html#h">H-N</a></li>
                    <li><a href="keyword.html#o">O-U</a></li>
                    <li><a href="keyword.html#v">V-Z</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="troubleshooting.html">トラブルシューティング</a>
                <ul class="submenu">
                    <li><a href="troubleshooting.html#char">文字リテラル</a></li>
                    <li><a href="troubleshooting.html#mut">ミュータブルなメソッド</a></li>
                    <li><a href="troubleshooting.html#match">パターンマッチ</a></li>
                    <li><a href="troubleshooting.html#unwrap">Nilable 型の操作</a></li>
                    <li><a href="troubleshooting.html#macro">マクロの構文エラー</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="evaluation.html">考察と評価</a>
                <ul class="submenu">
                    <li><a href="evaluation.html#quality">言語の出来</a></li>
                    <li><a href="evaluation.html#vs-lua">Luaとの比較</a></li>
                    <li><a href="evaluation.html#vs-teal">Tealとの比較</a></li>
                    <li><a href="evaluation.html#issues">課題と提案</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="main-content">
    <div class="header-nav">
        <a href="../en/function.html" class="lang-link">English</a>
    </div>
        <h1>関数</h1>
        <p>LuneScript の関数定義、呼び出し、および高度な機能について説明します。</p>

        <h2 id="def" id="keyword_fn">定義</h2>
        <p>関数は <code>fn</code> キーワードを使って定義します。</p>
        <pre><code class="language-lns"><span class="comment">// 引数なし、戻り値なし</span>
<span class="keyword">fn</span> hello() {
    print( <span class="string">"Hello"</span> );
}

<span class="comment">// 引数あり、戻り値あり</span>
<span class="keyword">fn</span> add( val1: <span class="type">int</span>, val2: <span class="type">int</span> ): <span class="type">int</span> {
    <span class="keyword">return</span> val1 + val2;
}
</code></pre>

        <h3>公開関数</h3>
        <p>モジュール外に公開するには <code>pub</code> を付けます。公開関数はトップレベル（最上位スコープ）でのみ定義可能です。</p>
        <pre><code class="language-lns"><span class="keyword">pub</span> <span class="keyword">fn</span> globalFunc() { print("global"); }
</code></pre>

        <h2 id="multi_ret">多値返却</h2>
        <p>LuneScript は複数の値を一度に返すことができます。</p>
        <pre><code class="language-lns"><span class="keyword">fn</span> div_mod( a: <span class="type">int</span>, b: <span class="type">int</span> ): <span class="type">int</span>, <span class="type">int</span> {
    <span class="keyword">return</span> a / b, a % b;
}
<span class="keyword">let</span> d, m = div_mod( <span class="number">10</span>, <span class="number">3</span> );
print( d, m ); <span class="comment">// 3, 1</span>
</code></pre>

        <div class="warn">
            <h3>多値返却の注意点 (Lua/LuneScript の仕様)</h3>
            <p>関数呼び出しを引数として渡す場合、<strong>最後の引数として渡された場合のみ</strong>、全ての戻り値が展開されます。</p>
            <pre><code class="language-lns"><span class="keyword">fn</span> func(): <span class="type">int</span>, <span class="type">int</span> { <span class="keyword">return</span> <span class="number">1</span>, <span class="number">2</span>; }

print( func() );      <span class="comment">// 1, 2 (すべて展開)</span>
print( func(), <span class="number">10</span> );  <span class="comment">// 1, 10 (2つ目の戻り値は捨てられる！)</span>
print( <span class="number">0</span>, func() );   <span class="comment">// 0, 1, 2 (すべて展開)</span>
</code></pre>
            <p>意図せず戻り値が捨てられる事故を防ぐため、LuneScript では多値を引数として渡す際、明示的に <code>**</code> を付けることを推奨しています（将来的に必須になる可能性があります）。</p>
            <pre><code class="language-lns">fn func(): int, int { return 1, 2; }
fn func2( ... ) {}
func2( func()** ); // 多値をすべて渡すことを明示
</code></pre>
        </div>

        <h2 id="closure">クロージャと匿名関数</h2>
        <p>名前のない関数（匿名関数）を作成し、変数に代入したり関数の引数として渡すことができます。</p>
        <pre><code class="language-lns"><span class="keyword">fn</span> run( cb: <span class="type">form</span> ) {
    cb();
}
<span class="keyword">let</span> val = <span class="number">10</span>;
run( <span class="keyword">fn</span>() {
    print( val ); <span class="comment">// 外部変数をキャプチャ (クロージャ)</span>
} );
</code></pre>

        <h2 id="form" id="keyword_form">Form (関数型)</h2>
        <p>関数の型を表すには <code>form</code> キーワードを使用します。ただし、単なる <code>form</code> 型は「任意の引数、任意の戻り値を持つ関数」という広すぎる型（実質
            <code>stem!</code> のようなもの）です。
        </p>
        <p>特定の厳密なシグネチャを持つ関数型を定義するには、<code>form</code> 宣言を使用します。</p>

        <pre><code class="language-lns"><span class="comment">// int を受け取り int を返す関数型 'IntFunc' を定義</span>
<span class="keyword">form</span> IntFunc( val: <span class="type">int</span> ): <span class="type">int</span>;

<span class="keyword">fn</span> exec( f: IntFunc, v: <span class="type">int</span> ) {
    print( f( v ) );
}

exec( <span class="keyword">fn</span>( v: <span class="type">int</span> ): <span class="type">int</span> { <span class="keyword">return</span> v * <span class="number">2</span>; }, <span class="number">10</span> ); <span class="comment">// 20</span>
</code></pre>

        <h2 id="varargs">可変長引数</h2>
        <p><code>...</code> を使用して可変長引数を定義できます。</p>
        <pre><code class="language-lns"><span class="keyword">fn</span> dumps( ... ) {
    <span class="keyword">let</span> list = [ ... ]; <span class="comment">// リストに変換</span>
    <span class="keyword">foreach</span> val <span class="keyword">in</span> list {
        print( val );
    }
}
dumps( <span class="number">1</span>, <span class="string">"test"</span>, <span class="keyword">true</span> );
</code></pre>
        <p>型を指定したい場合は、Generics を使用するか、リストで受け取る設計を検討してください。</p>

        <h2 id="args">引数の省略</h2>
        <p>Nilable 型の引数は、呼び出し時に省略可能です。省略された場合 <code>nil</code> が渡されます。</p>
        <pre><code class="language-lns"><span class="keyword">fn</span> opt( val: <span class="type">int</span>! ): <span class="type">int</span> {
    <span class="keyword">return</span> <span class="keyword">unwrap</span> val <span class="keyword">default</span> <span class="number">0</span>;
}
print( opt( <span class="number">10</span> ) ); <span class="comment">// 10</span>
print( opt() );     <span class="comment">// 0 (val is nil)</span>
</code></pre>
        <p>省略を明示するために <code>##</code> を使うことができます（<code>opt( ## )</code>）。これは「意図して省略した」ことをコード上で明確にするためです。</p>

    </div>
</body>

</html>