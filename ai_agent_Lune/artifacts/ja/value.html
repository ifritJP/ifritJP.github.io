<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuneScript 入門 - 値と型</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
</head>

<body>
    <div class="sidebar">
        <h1>LuneScript Guide</h1>
        <ul class="nav-links">
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="index.html">はじめに</a>
                <ul class="submenu">
                    <li><a href="index.html#features">主な特徴</a></li>
                    <li><a href="index.html#audience">対象読者</a></li>
                    <li><a href="index.html#license">ライセンス</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="learning.html">学習ガイド</a>
                <ul class="submenu">
                    <li><a href="learning.html#step1">ステップ1: 基礎</a></li>
                    <li><a href="learning.html#step2">ステップ2: 安全機能</a></li>
                    <li><a href="learning.html#step3">ステップ3: モダン機能</a></li>
                    <li><a href="learning.html#navigation">ドキュメント活用</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial.html">導入とHello World</a>
                <ul class="submenu">
                    <li><a href="tutorial.html#install">導入</a></li>
                    <li><a href="tutorial.html#hello">Hello World</a></li>
                    <li><a href="tutorial.html#options">lnsc コマンド</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="syntax.html">基本構文</a>
                <ul class="submenu">
                    <li><a href="syntax.html#comments">コメント</a></li>
                    <li><a href="syntax.html#vars">変数宣言</a></li>
                    <li><a href="syntax.html#flow">フロー解析による初期化</a></li>
                    <li><a href="syntax.html#scope">スコープブロック</a></li>
                    <li><a href="syntax.html#attr">属性</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="value.html">値と型</a>
                <ul class="submenu">
                    <li><a href="value.html#primitive">プリミティブ型</a></li>
                    <li><a href="value.html#collection">コレクション</a></li>
                    <li><a href="value.html#list">&nbsp;&nbsp;List</a></li>
                    <li><a href="value.html#map">&nbsp;&nbsp;Map</a></li>
                    <li><a href="value.html#set">&nbsp;&nbsp;Set</a></li>
                    <li><a href="value.html#nilable">Nilable 型</a></li>
                    <li><a href="value.html#cast">キャスト</a></li>
                    <li><a href="value.html#alge">Algebric Data Type</a></li>
                    <li><a href="value.html#enum">Enum</a></li>
                    <li><a href="value.html#tuple">Tuple</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="control.html">制御構文</a>
                <ul class="submenu">
                    <li><a href="control.html#if">if 文</a></li>
                    <li><a href="control.html#switch">switch 文</a></li>
                    <li><a href="control.html#while">while 文</a></li>
                    <li><a href="control.html#repeat">repeat 文</a></li>
                    <li><a href="control.html#for">for 文</a></li>
                    <li><a href="control.html#foreach">foreach 文</a></li>
                    <li><a href="control.html#apply">apply 文</a></li>
                    <li><a href="control.html#match">match 文</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="error.html">エラーハンドリング</a>
                <ul class="submenu">
                    <li><a href="error.html#ret">__Ret 型</a></li>
                    <li><a href="error.html#delegation">エラーの委譲</a></li>
                    <li><a href="error.html#best_practice">型と使い分け</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="function.html">関数</a>
                <ul class="submenu">
                    <li><a href="function.html#def">定義</a></li>
                    <li><a href="function.html#multi_ret">多値返却</a></li>
                    <li><a href="function.html#closure">クロージャ</a></li>
                    <li><a href="function.html#form">Form (関数型)</a></li>
                    <li><a href="function.html#varargs">可変長引数</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="class.html">クラス</a>
                <ul class="submenu">
                    <li><a href="class.html#def">定義とインスタンス化</a></li>
                    <li><a href="class.html#inherit">継承とオーバーライド</a></li>
                    <li><a href="class.html#abstract">抽象クラス</a></li>
                    <li><a href="class.html#interface">インタフェース</a></li>
                    <li><a href="class.html#advertise">Advertise</a></li>
                    <li><a href="class.html#mapping">Mapping</a></li>
                    <li><a href="class.html#proto">プロトタイプ宣言</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="generics.html">Generics</a>
                <ul class="submenu">
                    <li><a href="generics.html#func">関数の Generics</a></li>
                    <li><a href="generics.html#class">クラスの Generics</a></li>
                    <li><a href="generics.html#constraint">型パラメータの制約</a></li>
                    <li><a href="generics.html#method">メソッドの Generics</a></li>
                    <li><a href="generics.html#mut">Generics と Mutability</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="macro.html">マクロ</a>
                <ul class="submenu">
                    <li><a href="macro.html#def">定義</a></li>
                    <li><a href="macro.html#arg">引数</a></li>
                    <li><a href="macro.html#quote">Quoting</a></li>
                    <li><a href="macro.html#statement">Macro Statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="advanced.html">高度な機能</a>
                <ul class="submenu">
                    <li><a href="advanced.html#match">パターンマッチ</a></li>
                    <li><a href="advanced.html#async">非同期処理</a></li>
                    <li><a href="advanced.html#glue">Glue コード</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="module.html">モジュールとプロジェクト</a>
                <ul class="submenu">
                    <li><a href="module.html#module">モジュールシステム</a></li>
                    <li><a href="module.html#project">プロジェクト設定</a></li>
                    <li><a href="module.html#provide">Provide</a></li>
                    <li><a href="module.html#require">Require</a></li>
                    <li><a href="module.html#subfile">Subfile</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="standard.html">標準ライブラリ</a>
                <ul class="submenu">
                    <li><a href="standard.html#builtin">ビルトイン関数</a></li>
                    <li><a href="standard.html#lua">Lua 標準ライブラリ</a></li>
                    <li><a href="standard.html#io">IO</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_macro.html">実践: マクロ活用</a>
                <ul class="submenu">
                    <li><a href="tutorial_macro.html#step1">Step 1: デバッグプリント</a></li>
                    <li><a href="tutorial_macro.html#step2">Step 2: アサーション</a></li>
                    <li><a href="tutorial_macro.html#step3">Step 3: 計測</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_parser.html">実践: 数式パーサ</a>
                <ul class="submenu">
                    <li><a href="tutorial_parser.html#goal">目標</a></li>
                    <li><a href="tutorial_parser.html#token">Step 1: トークン定義</a></li>
                    <li><a href="tutorial_parser.html#lexer">Step 2: 字句解析</a></li>
                    <li><a href="tutorial_parser.html#ast">Step 3: 構文木 (AST)</a></li>
                    <li><a href="tutorial_parser.html#parser">Step 4: 構文解析</a></li>
                    <li><a href="tutorial_parser.html#eval">Step 5: 評価と実行</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="keyword.html">キーワード一覧</a>
                <ul class="submenu">
                    <li><a href="keyword.html#a">A-G</a></li>
                    <li><a href="keyword.html#h">H-N</a></li>
                    <li><a href="keyword.html#o">O-U</a></li>
                    <li><a href="keyword.html#v">V-Z</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="troubleshooting.html">トラブルシューティング</a>
                <ul class="submenu">
                    <li><a href="troubleshooting.html#char">文字リテラル</a></li>
                    <li><a href="troubleshooting.html#mut">ミュータブルなメソッド</a></li>
                    <li><a href="troubleshooting.html#match">パターンマッチ</a></li>
                    <li><a href="troubleshooting.html#unwrap">Nilable 型の操作</a></li>
                    <li><a href="troubleshooting.html#macro">マクロの構文エラー</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="evaluation.html">考察と評価</a>
                <ul class="submenu">
                    <li><a href="evaluation.html#quality">言語の出来</a></li>
                    <li><a href="evaluation.html#vs-lua">Luaとの比較</a></li>
                    <li><a href="evaluation.html#vs-teal">Tealとの比較</a></li>
                    <li><a href="evaluation.html#issues">課題と提案</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="header-nav">
            <a href="../en/value.html" class="lang-link">English</a>
        </div>
        <h1>値と型</h1>
        <p>LuneScript で扱う値と型について詳細に説明します。</p>

        <h2 id="primitive">プリミティブ型</h2>
        <table class="simple-table">
            <thead>
                <tr>
                    <th>型名</th>
                    <th>説明</th>
                    <th>例</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>int</code></td>
                    <td>整数型</td>
                    <td><code>1</code>, <code>-10</code>, <code>0x10</code></td>
                </tr>
                <tr>
                    <td><code>real</code></td>
                    <td>実数型（浮動小数点数）</td>
                    <td><code>1.0</code>, <code>3.14</code></td>
                </tr>
                <tr>
                    <td><code>bool</code></td>
                    <td>真偽値</td>
                    <td><code>true</code>, <code>false</code></td>
                </tr>
                <tr>
                    <td><code>str</code></td>
                    <td>文字列（不変）</td>
                    <td><code>"hello"</code>, <code>'world'</code></td>
                </tr>
                <tr>
                    <td><code>stem</code></td>
                    <td>nil 以外の全ての型</td>
                    <td>(任意の非 nil 値)</td>
                </tr>
            </tbody>
        </table>
        <p><code>stem</code> は全ての型の基底となる型ですが、<code>nil</code> だけは保持できません。<code>nil</code> を許容するには <code>stem!</code>
            を使用します。</p>

        <h2 id="collection">コレクション</h2>

        <h3 id="list">List&lt;T&gt; (リスト)</h3>
        <p>要素の追加・削除が可能な動的配列です。</p>
        <pre><code class="language-lns"><span class="keyword">let</span> <span class="keyword">mut</span> list: <span class="type">List</span>&lt;<span class="type">int</span>&gt; = [ <span class="number">10</span>, <span class="number">20</span> ]; <span class="comment">// 初期化</span>
list.insert( <span class="number">30</span> );  <span class="comment">// 追加: [ 10, 20, 30 ]</span>
list.remove();      <span class="comment">// 末尾削除: [ 10, 20 ]</span>
print( list[ <span class="number">1</span> ] ); <span class="comment">// アクセス (1-based index): 10</span>
print( #list );     <span class="comment">// サイズ取得: 2</span>
</code></pre>
        <div class="note">
            LuneScript (および Lua) のリストインデックスは <strong>1 から始まります</strong>。範囲外アクセスは未定義動作となるため注意してください。
        </div>


        <h3 id="map">Map&lt;K,V&gt; (連想配列)</h3>
        <p>キーと値のペアを保持します。JSON ライクなリテラルを使用できます。</p>
        <pre><code class="language-lns"><span class="keyword">let</span> <span class="keyword">mut</span> map: <span class="type">Map</span>&lt;<span class="type">str</span>,<span class="type">int</span>&gt; = {
    <span class="string">"a"</span>: <span class="number">1</span>,
    <span class="string">"b"</span>: <span class="number">2</span>
};
<span class="comment">// アクセス</span>
print( map[ <span class="string">"a"</span> ] ); <span class="comment">// 1</span>
print( map.b );      <span class="comment">// 文字列キーならドットでもアクセス可</span>

<span class="comment">// 削除 (nil を代入)</span>
map.a = <span class="keyword">nil</span>;
</code></pre>
        <div class="note">
            Map へのアクセス結果は常に <strong>Nilable (T!)</strong> となります。キーに対応する値が存在しない場合 <code>nil</code> が返るためです。
        </div>

        <h3 id="set">Set&lt;T&gt; (集合)</h3>
        <p>重複のない値の集合を管理します。リテラルは <code>(@ ... )</code> です。</p>
        <pre><code class="language-lns"><span class="keyword">let</span> <span class="keyword">mut</span> set = (@ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> );
set.add( <span class="number">4</span> );       <span class="comment">// 追加</span>
set.del( <span class="number">1</span> );       <span class="comment">// 削除</span>
print( set.has( <span class="number">2</span> ) );  <span class="comment">// 存在確認: true</span>
print( set.len() );     <span class="comment">// 要素数: 3</span>
</code></pre>
        <p>集合演算 <code>or</code> (和集合), <code>and</code> (積集合), <code>sub</code> (差集合) もサポートしています。</p>

        <h2 id="nilable">Nilable 型 (Null Safety)</h2>
        <p>型名の末尾に <code>!</code> を付けることで、<code>nil</code> を保持可能な型になります。</p>
        <pre><code class="language-lns"><span class="keyword">let</span> val1: <span class="type">int</span> = <span class="number">1</span>;   <span class="comment">// nil 不可</span>
<span class="keyword">let</span> val2: <span class="type">int</span>! = <span class="keyword">nil</span>; <span class="comment">// nil 可 (int or nil)</span>
</code></pre>
        <p>Nilable 型はそのままでは計算などに使用できません（安全のため）。必ず <strong>Unwrap (非 Nil化)</strong> する必要があります。</p>

        <h3 id="keyword_unwrap">unwrap</h3>
        <p>強制的に nil を取り除きます。値が nil の場合は実行時エラーになります。</p>
        <pre><code class="language-lns"><span class="keyword">let</span> a: <span class="type">int</span>! = <span class="number">10</span>;
<span class="keyword">let</span> b: <span class="type">int</span> = <span class="keyword">unwrap</span> a;
</code></pre>
        <p>安全に unwrap するために <code>default</code> 値を指定できます。</p>
        <pre><code class="language-lns"><span class="keyword">let</span> a: <span class="type">int</span>! = <span class="keyword">nil</span>;
<span class="keyword">let</span> c: <span class="type">int</span> = <span class="keyword">unwrap</span> a <span class="keyword">default</span> <span class="number">0</span>; <span class="comment">// nil なら 0 になる</span>
</code></pre>

        <h3 id="keyword_if_let">if! let / when!</h3>
        <p>変数が nil でない場合のみブロックを実行する構文です。</p>
        <pre><code class="language-lns">fn funcReturnsNilable(): int! { return 1; }
<span class="keyword">if</span>! <span class="keyword">let</span> x = funcReturnsNilable() {
    <span class="comment">// x はここでは非 nil (int) として扱える</span>
    print( x + <span class="number">1</span> );
} <span class="keyword">else</span> {
    print( <span class="string">"x was nil"</span> );
}
</code></pre>
        <p><code>when!</code> は既存の変数が nil かどうかをチェックします。</p>
        <pre><code class="language-lns"><span class="keyword">let</span> val: <span class="type">int</span>! = <span class="keyword">nil</span>;
<span class="keyword">when</span>! val {
    <span class="comment">// このブロック内では val は int 型 (immutable)</span>
}
</code></pre>

        <h3 id="keyword_let_bang">let! .. then ..</h3>
        <p>「変数が nil の場合の処理」を先に記述するスタイルです（Guard 節に近い使い方）。</p>
        <pre><code class="language-lns">fn funcReturnsNilable(): int! { return nil; }
<span class="keyword">let</span>! x = funcReturnsNilable() {
    <span class="comment">// x が nil の場合に実行される</span>
    <span class="keyword">return</span>;
}
<span class="comment">// ここでは x は非 nil</span>
print( x + 1 );
</code></pre>

        <h3 id="nil_conditional">Nil 条件演算子 ($)</h3>
        <p>nilable な値に対し、nil でない場合のみメンバアクセスや関数呼び出しを行います。値が nil の場合は <code>nil</code> を返します。評価結果は常に Nilable 型になります。</p>
        <ul>
            <li><strong>メンバアクセス:</strong> <code>obj$.member</code></li>
            <li><strong>索引アクセス:</strong> <code>obj$[index]</code></li>
            <li><strong>関数呼び出し:</strong> <code>func$(args)</code></li>
        </ul>
        <pre><code class="language-lns"><span class="keyword">class</span> Test {
    <span class="keyword">pub</span> <span class="keyword">let</span> val: <span class="type">List</span>&lt;<span class="type">int</span>&gt;;
    <span class="keyword">pub</span> <span class="keyword">fn</span> func(): <span class="type">int</span> { <span class="keyword">return</span> <span class="number">100</span>; }
}

<span class="keyword">fn</span> sub( test: Test! ) {
    <span class="comment">// test が nil ならすべて nil になる</span>
    print( test$.val$[<span class="number">1</span>], test$.func$() );
}

sub( <span class="keyword">new</span> Test( [ <span class="number">1</span>, <span class="number">2</span> ] ) ); <span class="comment">// 1 100</span>
sub( <span class="keyword">nil</span> );                   <span class="comment">// nil nil</span>
</code></pre>

        <h2 id="cast">キャスト</h2>
        <p>型変換には <code>@@</code> (強制) と <code>@@@</code> (安全) があります。</p>

        <h3>強制キャスト (@@)</h3>
        <pre><code class="language-lns"><span class="keyword">let</span> val: <span class="type">stem</span> = <span class="number">10</span>;
<span class="keyword">let</span> i = val@@<span class="type">int</span>; <span class="comment">// チェックなしで変換。失敗時の動作は未定義またはエラー。</span>
</code></pre>

        <h3>安全なキャスト (@@@)</h3>
        <pre><code class="language-lns"><span class="keyword">let</span> val: <span class="type">stem</span> = <span class="string">"test"</span>;
<span class="keyword">if</span>! <span class="keyword">let</span> i = val@@@<span class="type">int</span> {
    print( <span class="string">"Integer!"</span> );
} <span class="keyword">else</span> {
    print( <span class="string">"Not an integer"</span> );
}
</code></pre>
        <p>変換できない場合は <code>nil</code> が返ります。</p>

        <h2 id="alge" id="keyword_alge">Algebric Data Type (代数的データ型)</h2>
        <p><code>alge</code> は列挙型の一種ですが、各値 (コンストラクタ) がパラメータを持つことができます。直和型 (Tagged Union) です。</p>
        <pre><code class="language-lns"><span class="keyword">alge</span> Shape {
    Rect( <span class="type">real</span>, <span class="type">real</span> ),
    Circle( <span class="type">real</span> ),
}

<span class="keyword">let</span> s = Shape.Rect( <span class="number">10.0</span>, <span class="number">20.0</span> );

<span class="keyword">match</span> s {
    <span class="keyword">case</span> .Rect( w, h ) { print( <span class="string">"Rect:"</span>, w * h ); }
    <span class="keyword">case</span> .Circle( r ) { print( <span class="string">"Circle:"</span>, r * r * <span class="number">3.14</span> ); }
}
</code></pre>

        <h2 id="enum" id="keyword_enum">Enum (列挙型)</h2>
        <p>単純な値の列挙です。整数、実数、文字列を割り当てることができます。</p>
        <pre><code class="language-lns"><span class="keyword">enum</span> Color {
    Red = <span class="number">0</span>,
    Green, <span class="comment">// 1 (自動付番)</span>
    Blue,  <span class="comment">// 2</span>
}
print( Color.Red ); <span class="comment">// 0</span>
print( Color.Red.$_txt ); <span class="comment">// "Color.Red" (文字列表現)</span>
</code></pre>
        <p>生の値から Enum への変換には <code>_from</code> を使います。</p>
        <pre><code class="language-lns"><span class="keyword">enum</span> Color { Green=1 }
<span class="keyword">let</span> c = <span class="keyword">unwrap</span> Color._from( <span class="number">1</span> ); <span class="comment">// Color.Green (nilable なので unwrap が必要)</span>
</code></pre>

        <h2 id="tuple">Tuple (タプル)</h2>
        <p>複数の値をまとめて扱います。</p>
        <pre><code class="language-lns"><span class="keyword">let</span> t: (<span class="type">int</span>, <span class="type">str</span>) = (= <span class="number">1</span>, <span class="string">"ok"</span> );
</code></pre>
        <p>関数への引数渡しなどで展開するには <code>...</code> を使います。</p>
        <pre><code class="language-lns"><span class="keyword">fn</span> func( i: <span class="type">int</span>, s: <span class="type">str</span> ) { print( i, s ); }
<span class="keyword">let</span> t: (<span class="type">int</span>, <span class="type">str</span>) = (= <span class="number">1</span>, <span class="string">"ok"</span> );
func( t... );
</code></pre>

    </div>
</body>

</html>