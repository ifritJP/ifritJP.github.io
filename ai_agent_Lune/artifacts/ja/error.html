<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuneScript 入門 - エラーハンドリング</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
</head>

<body>
    <div class="sidebar">
        <h1>LuneScript Guide</h1>
        <ul class="nav-links">
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="index.html">はじめに</a>
                <ul class="submenu">
                    <li><a href="index.html#features">主な特徴</a></li>
                    <li><a href="index.html#audience">対象読者</a></li>
                    <li><a href="index.html#license">ライセンス</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="learning.html">学習ガイド</a>
                <ul class="submenu">
                    <li><a href="learning.html#step1">ステップ1: 基礎</a></li>
                    <li><a href="learning.html#step2">ステップ2: 安全機能</a></li>
                    <li><a href="learning.html#step3">ステップ3: モダン機能</a></li>
                    <li><a href="learning.html#navigation">ドキュメント活用</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial.html">導入とHello World</a>
                <ul class="submenu">
                    <li><a href="tutorial.html#install">導入</a></li>
                    <li><a href="tutorial.html#hello">Hello World</a></li>
                    <li><a href="tutorial.html#options">lnsc コマンド</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="syntax.html">基本構文</a>
                <ul class="submenu">
                    <li><a href="syntax.html#comments">コメント</a></li>
                    <li><a href="syntax.html#vars">変数宣言</a></li>
                    <li><a href="syntax.html#flow">フロー解析による初期化</a></li>
                    <li><a href="syntax.html#scope">スコープブロック</a></li>
                    <li><a href="syntax.html#attr">属性</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="value.html">値と型</a>
                <ul class="submenu">
                    <li><a href="value.html#primitive">プリミティブ型</a></li>
                    <li><a href="value.html#collection">コレクション</a></li>
                    <li><a href="value.html#list">&nbsp;&nbsp;List</a></li>
                    <li><a href="value.html#map">&nbsp;&nbsp;Map</a></li>
                    <li><a href="value.html#set">&nbsp;&nbsp;Set</a></li>
                    <li><a href="value.html#nilable">Nilable 型</a></li>
                    <li><a href="value.html#cast">キャスト</a></li>
                    <li><a href="value.html#alge">Algebric Data Type</a></li>
                    <li><a href="value.html#enum">Enum</a></li>
                    <li><a href="value.html#tuple">Tuple</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="control.html">制御構文</a>
                <ul class="submenu">
                    <li><a href="control.html#if">if 文</a></li>
                    <li><a href="control.html#switch">switch 文</a></li>
                    <li><a href="control.html#while">while 文</a></li>
                    <li><a href="control.html#repeat">repeat 文</a></li>
                    <li><a href="control.html#for">for 文</a></li>
                    <li><a href="control.html#foreach">foreach 文</a></li>
                    <li><a href="control.html#apply">apply 文</a></li>
                    <li><a href="control.html#match">match 文</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="error.html">エラーハンドリング</a>
                <ul class="submenu">
                    <li><a href="error.html#ret">__Ret 型</a></li>
                    <li><a href="error.html#delegation">エラーの委譲</a></li>
                    <li><a href="error.html#best_practice">型と使い分け</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="function.html">関数</a>
                <ul class="submenu">
                    <li><a href="function.html#def">定義</a></li>
                    <li><a href="function.html#multi_ret">多値返却</a></li>
                    <li><a href="function.html#closure">クロージャ</a></li>
                    <li><a href="function.html#form">Form (関数型)</a></li>
                    <li><a href="function.html#varargs">可変長引数</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="class.html">クラス</a>
                <ul class="submenu">
                    <li><a href="class.html#def">定義とインスタンス化</a></li>
                    <li><a href="class.html#inherit">継承とオーバーライド</a></li>
                    <li><a href="class.html#abstract">抽象クラス</a></li>
                    <li><a href="class.html#interface">インタフェース</a></li>
                    <li><a href="class.html#advertise">Advertise</a></li>
                    <li><a href="class.html#mapping">Mapping</a></li>
                    <li><a href="class.html#proto">プロトタイプ宣言</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="generics.html">Generics</a>
                <ul class="submenu">
                    <li><a href="generics.html#func">関数の Generics</a></li>
                    <li><a href="generics.html#class">クラスの Generics</a></li>
                    <li><a href="generics.html#constraint">型パラメータの制約</a></li>
                    <li><a href="generics.html#method">メソッドの Generics</a></li>
                    <li><a href="generics.html#mut">Generics と Mutability</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="macro.html">マクロ</a>
                <ul class="submenu">
                    <li><a href="macro.html#def">定義</a></li>
                    <li><a href="macro.html#arg">引数</a></li>
                    <li><a href="macro.html#quote">Quoting</a></li>
                    <li><a href="macro.html#statement">Macro Statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="advanced.html">高度な機能</a>
                <ul class="submenu">
                    <li><a href="advanced.html#match">パターンマッチ</a></li>
                    <li><a href="advanced.html#async">非同期処理</a></li>
                    <li><a href="advanced.html#glue">Glue コード</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="module.html">モジュールとプロジェクト</a>
                <ul class="submenu">
                    <li><a href="module.html#module">モジュールシステム</a></li>
                    <li><a href="module.html#project">プロジェクト設定</a></li>
                    <li><a href="module.html#provide">Provide</a></li>
                    <li><a href="module.html#require">Require</a></li>
                    <li><a href="module.html#subfile">Subfile</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="standard.html">標準ライブラリ</a>
                <ul class="submenu">
                    <li><a href="standard.html#builtin">ビルトイン関数</a></li>
                    <li><a href="standard.html#lua">Lua 標準ライブラリ</a></li>
                    <li><a href="standard.html#io">IO</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_macro.html">実践: マクロ活用</a>
                <ul class="submenu">
                    <li><a href="tutorial_macro.html#step1">Step 1: デバッグプリント</a></li>
                    <li><a href="tutorial_macro.html#step2">Step 2: アサーション</a></li>
                    <li><a href="tutorial_macro.html#step3">Step 3: 計測</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_parser.html">実践: 数式パーサ</a>
                <ul class="submenu">
                    <li><a href="tutorial_parser.html#goal">目標</a></li>
                    <li><a href="tutorial_parser.html#token">Step 1: トークン定義</a></li>
                    <li><a href="tutorial_parser.html#lexer">Step 2: 字句解析</a></li>
                    <li><a href="tutorial_parser.html#ast">Step 3: 構文木 (AST)</a></li>
                    <li><a href="tutorial_parser.html#parser">Step 4: 構文解析</a></li>
                    <li><a href="tutorial_parser.html#eval">Step 5: 評価と実行</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="keyword.html">キーワード一覧</a>
                <ul class="submenu">
                    <li><a href="keyword.html#a">A-G</a></li>
                    <li><a href="keyword.html#h">H-N</a></li>
                    <li><a href="keyword.html#o">O-U</a></li>
                    <li><a href="keyword.html#v">V-Z</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="troubleshooting.html">トラブルシューティング</a>
                <ul class="submenu">
                    <li><a href="troubleshooting.html#char">文字リテラル</a></li>
                    <li><a href="troubleshooting.html#mut">ミュータブルなメソッド</a></li>
                    <li><a href="troubleshooting.html#match">パターンマッチ</a></li>
                    <li><a href="troubleshooting.html#unwrap">Nilable 型の操作</a></li>
                    <li><a href="troubleshooting.html#macro">マクロの構文エラー</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="evaluation.html">考察と評価</a>
                <ul class="submenu">
                    <li><a href="evaluation.html#quality">言語の出来</a></li>
                    <li><a href="evaluation.html#vs-lua">Luaとの比較</a></li>
                    <li><a href="evaluation.html#vs-teal">Tealとの比較</a></li>
                    <li><a href="evaluation.html#issues">課題と提案</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="main-content">
    <div class="header-nav">
        <a href="../en/error.html" class="lang-link">English</a>
    </div>
        <h1>エラーハンドリング</h1>
        <p>LuneScript では、<code>nil</code> を利用したシンプルなエラー表現から、型安全な <code>__Ret</code>
            型、そしてそれらを効率的に扱う「エラーの委譲」機能まで、堅牢なアプリケーションを開発するための仕組みが整っています。</p>

        <h2 id="ret">__Ret&lt;T, E&gt; 型</h2>
        <p><code>__Ret&lt;T, E&gt;</code> は、処理が成功した際の値（Ok）と、失敗した際のエラー情報（Err）を一つの型で表現するための代数的データ型 (ADT) です。Rust の
            <code>Result&lt;T, E&gt;</code> に相当します。</p>

        <pre><code class="language-lns">// 内部的な定義イメージ
alge __Ret&lt;T, E&gt; {
    Ok( val: T ),
    Err( err: E ),
}
</code></pre>

        <h3>基本的な使い方</h3>
        <p>値を返すときは <code>.Ok(値)</code>、エラーを返すときは <code>.Err(エラー)</code> を使用します。受け取った側は <code>match</code> 文で安全に分解できます。
        </p>
        <pre><code class="language-lns">fn divide( a: real, b: real ): __Ret&lt;real, str&gt; {
    if b == 0.0 {
        return .Err( "division by zero" );
    }
    return .Ok( a / b );
}

let result = divide( 10.0, 0.0 );
match result {
    case .Ok( val ) { print( "Success:", val ); }
    case .Err( msg ) { print( "Error:", msg ); }
}
</code></pre>

        <h3 id="er">__Er 型</h3>
        <p>エラー情報として、単なる文字列ではなく位置情報などを含む詳細な情報が必要な場合、標準の <code>__Er</code> 型を利用することが推奨されます。</p>
        <pre><code class="language-lns">fn sub(): __Ret&lt;int, __Er&gt; {
    return .Err( __serr( "something went wrong" ) );
}
</code></pre>

        <h2 id="delegation">エラーの委譲 (<code>!</code> 演算子)</h2>
        <p>エラーが発生する可能性のある関数を連続して呼び出す場合、都度 <code>match</code> や <code>if</code> でチェックするとロジックが見づらくなります。<code>!</code>
            演算子はこのチェックを自動化します。</p>

        <h3>動作原理</h3>
        <p>式の末尾に <code>!</code> を付けると、コンパイラは以下のコードを生成したかのように振る舞います。</p>
        <ul>
            <li>値が <strong>正常 (Ok または 非nil)</strong> なら、その値を取り出して処理を続行する。</li>
            <li>値が <strong>エラー (Err または nil)</strong> なら、現在の関数から<strong>即座にそのエラーを return して抜ける</strong>。</li>
        </ul>

        <pre><code class="language-lns">fn step1(): __Ret&lt;int, str&gt; { return .Ok(1); }
fn step2(val: int): __Ret&lt;int, str&gt; { return .Ok(val + 1); }

fn series(): __Ret&lt;int, str&gt; {
    // step1() が Err なら即座に return .Err(...) する
    let res1 = step1()!; 
    
    // step2() も同様。正常なら res2 に値が入る
    let res2 = step2( res1 )!;
    
    return .Ok( res2 );
}
</code></pre>

        <h3>Nilable との組み合わせ</h3>
        <p><code>!</code> 演算子は Nilable 型 (<code>T!</code>) にも使用できます。この場合、現在の関数の戻り値も Nilable である必要があります。</p>
        <pre><code class="language-lns">fn getVal(): int! { return nil; }

fn process(): int! {
    let val = getVal()!; // getVal() が nil なら即座に return nil
    return val + 1;
}
</code></pre>

        <h2 id="best_practice">使い分けの指針</h2>
        <table class="simple-table">
            <thead>
                <tr>
                    <th>手法</th>
                    <th>適したケース</th>
                    <th>特徴</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Nilable (T!)</strong></td>
                    <td>単純な不在、またはエラー内容が自明な場合。</td>
                    <td>最も軽量で手軽。</td>
                </tr>
                <tr>
                    <td><strong>多値返却 (T!, str!)</strong></td>
                    <td>Lua で一般的なスタイルとの親和性を重視する場合。</td>
                    <td>Lua 互換性が高い。<code>!</code> での委譲も可能。</td>
                </tr>
                <tr>
                    <td><strong>__Ret&lt;T, E&gt;</strong></td>
                    <td>複雑なエラー情報を型安全に扱いたい場合。</td>
                    <td>最も堅牢。関数が返す状態が明確になる。</td>
                </tr>
            </tbody>
        </table>

        <div class="note">
            エラーの委譲 (<code>!</code>) を使うことで、正常系（Happy
            Path）の処理をメインラインに記述でき、例外処理を背後に隠すことができます。これにより、複雑なビジネスロジックの見通しが劇的に改善されます。
        </div>
    </div>
</body>

</html>