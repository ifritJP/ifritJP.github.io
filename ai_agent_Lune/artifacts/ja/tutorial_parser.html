<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuneScript 入門 - 実践: 数式パーサ</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4708B8S6ES"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-4708B8S6ES');
</script>
</head>

<body>
    <div class="sidebar">
        <h1>LuneScript Guide</h1>
        <ul class="nav-links">
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="index.html">はじめに</a>
                <ul class="submenu">
                    <li><a href="index.html#features">主な特徴</a></li>
                    <li><a href="index.html#audience">対象読者</a></li>
                    <li><a href="index.html#license">ライセンス</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="learning.html">学習ガイド</a>
                <ul class="submenu">
                    <li><a href="learning.html#step1">ステップ1: 基礎</a></li>
                    <li><a href="learning.html#step2">ステップ2: 安全機能</a></li>
                    <li><a href="learning.html#step3">ステップ3: モダン機能</a></li>
                    <li><a href="learning.html#navigation">ドキュメント活用</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial.html">導入とHello World</a>
                <ul class="submenu">
                    <li><a href="tutorial.html#install">導入</a></li>
                    <li><a href="tutorial.html#hello">Hello World</a></li>
                    <li><a href="tutorial.html#options">lnsc コマンド</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="syntax.html">基本構文</a>
                <ul class="submenu">
                    <li><a href="syntax.html#comments">コメント</a></li>
                    <li><a href="syntax.html#vars">変数宣言</a></li>
                    <li><a href="syntax.html#flow">フロー解析による初期化</a></li>
                    <li><a href="syntax.html#scope">スコープブロック</a></li>
                    <li><a href="syntax.html#attr">属性</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="value.html">値と型</a>
                <ul class="submenu">
                    <li><a href="value.html#primitive">プリミティブ型</a></li>
                    <li><a href="value.html#collection">コレクション</a></li>
                    <li><a href="value.html#list">&nbsp;&nbsp;List</a></li>
                    <li><a href="value.html#map">&nbsp;&nbsp;Map</a></li>
                    <li><a href="value.html#set">&nbsp;&nbsp;Set</a></li>
                    <li><a href="value.html#nilable">Nilable 型</a></li>
                    <li><a href="value.html#cast">キャスト</a></li>
                    <li><a href="value.html#alge">Algebric Data Type</a></li>
                    <li><a href="value.html#enum">Enum</a></li>
                    <li><a href="value.html#tuple">Tuple</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="control.html">制御構文</a>
                <ul class="submenu">
                    <li><a href="control.html#if">if 文</a></li>
                    <li><a href="control.html#switch">switch 文</a></li>
                    <li><a href="control.html#while">while 文</a></li>
                    <li><a href="control.html#repeat">repeat 文</a></li>
                    <li><a href="control.html#for">for 文</a></li>
                    <li><a href="control.html#foreach">foreach 文</a></li>
                    <li><a href="control.html#apply">apply 文</a></li>
                    <li><a href="control.html#match">match 文</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="error.html">エラーハンドリング</a>
                <ul class="submenu">
                    <li><a href="error.html#ret">__Ret 型</a></li>
                    <li><a href="error.html#delegation">エラーの委譲</a></li>
                    <li><a href="error.html#best_practice">型と使い分け</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="function.html">関数</a>
                <ul class="submenu">
                    <li><a href="function.html#def">定義</a></li>
                    <li><a href="function.html#multi_ret">多値返却</a></li>
                    <li><a href="function.html#closure">クロージャ</a></li>
                    <li><a href="function.html#form">Form (関数型)</a></li>
                    <li><a href="function.html#varargs">可変長引数</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="class.html">クラス</a>
                <ul class="submenu">
                    <li><a href="class.html#def">定義とインスタンス化</a></li>
                    <li><a href="class.html#inherit">継承とオーバーライド</a></li>
                    <li><a href="class.html#abstract">抽象クラス</a></li>
                    <li><a href="class.html#interface">インタフェース</a></li>
                    <li><a href="class.html#advertise">Advertise</a></li>
                    <li><a href="class.html#mapping">Mapping</a></li>
                    <li><a href="class.html#proto">プロトタイプ宣言</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="generics.html">Generics</a>
                <ul class="submenu">
                    <li><a href="generics.html#func">関数の Generics</a></li>
                    <li><a href="generics.html#class">クラスの Generics</a></li>
                    <li><a href="generics.html#constraint">型パラメータの制約</a></li>
                    <li><a href="generics.html#method">メソッドの Generics</a></li>
                    <li><a href="generics.html#mut">Generics と Mutability</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="macro.html">マクロ</a>
                <ul class="submenu">
                    <li><a href="macro.html#def">定義</a></li>
                    <li><a href="macro.html#arg">引数</a></li>
                    <li><a href="macro.html#quote">Quoting</a></li>
                    <li><a href="macro.html#statement">Macro Statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="advanced.html">高度な機能</a>
                <ul class="submenu">
                    <li><a href="advanced.html#match">パターンマッチ</a></li>
                    <li><a href="advanced.html#async">非同期処理</a></li>
                    <li><a href="advanced.html#glue">Glue コード</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="module.html">モジュールとプロジェクト</a>
                <ul class="submenu">
                    <li><a href="module.html#module">モジュールシステム</a></li>
                    <li><a href="module.html#project">プロジェクト設定</a></li>
                    <li><a href="module.html#provide">Provide</a></li>
                    <li><a href="module.html#require">Require</a></li>
                    <li><a href="module.html#subfile">Subfile</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="standard.html">標準ライブラリ</a>
                <ul class="submenu">
                    <li><a href="standard.html#builtin">ビルトイン関数</a></li>
                    <li><a href="standard.html#lua">Lua 標準ライブラリ</a></li>
                    <li><a href="standard.html#io">IO</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_macro.html">実践: マクロ活用</a>
                <ul class="submenu">
                    <li><a href="tutorial_macro.html#step1">Step 1: デバッグプリント</a></li>
                    <li><a href="tutorial_macro.html#step2">Step 2: アサーション</a></li>
                    <li><a href="tutorial_macro.html#step3">Step 3: 計測</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_parser.html">実践: 数式パーサ</a>
                <ul class="submenu">
                    <li><a href="tutorial_parser.html#goal">目標</a></li>
                    <li><a href="tutorial_parser.html#token">Step 1: トークン定義</a></li>
                    <li><a href="tutorial_parser.html#lexer">Step 2: 字句解析</a></li>
                    <li><a href="tutorial_parser.html#ast">Step 3: 構文木 (AST)</a></li>
                    <li><a href="tutorial_parser.html#parser">Step 4: 構文解析</a></li>
                    <li><a href="tutorial_parser.html#eval">Step 5: 評価と実行</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="keyword.html">キーワード一覧</a>
                <ul class="submenu">
                    <li><a href="keyword.html#a">A-G</a></li>
                    <li><a href="keyword.html#h">H-N</a></li>
                    <li><a href="keyword.html#o">O-U</a></li>
                    <li><a href="keyword.html#v">V-Z</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="troubleshooting.html">トラブルシューティング</a>
                <ul class="submenu">
                    <li><a href="troubleshooting.html#char">文字リテラル</a></li>
                    <li><a href="troubleshooting.html#mut">ミュータブルなメソッド</a></li>
                    <li><a href="troubleshooting.html#match">パターンマッチ</a></li>
                    <li><a href="troubleshooting.html#unwrap">Nilable 型の操作</a></li>
                    <li><a href="troubleshooting.html#macro">マクロの構文エラー</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="evaluation.html">考察と評価</a>
                <ul class="submenu">
                    <li><a href="evaluation.html#quality">言語の出来</a></li>
                    <li><a href="evaluation.html#vs-lua">Luaとの比較</a></li>
                    <li><a href="evaluation.html#vs-teal">Tealとの比較</a></li>
                    <li><a href="evaluation.html#issues">課題と提案</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="main-content">
    <div class="header-nav">
        <a href="../en/tutorial_parser.html" class="lang-link">English</a>
    </div>
        <h1>実践: 数式パーサの作成</h1>

        <p>LuneScript の強力な型システム、特に代数的データ型 (Algebric Data Type) とパターンマッチを活用して、数式パーサ（計算機）を作成してみましょう。<br>
            このチュートリアルでは、<code>"1 + 2 * 3"</code> のような文字列を解析し、計算結果を出すプログラムをステップ・バイ・ステップで作成します。</p>

        <h2 id="goal">目標</h2>
        <p>以下の機能を実装します。</p>
        <ul>
            <li>四則演算 (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>) と括弧 <code>()</code> のサポート。</li>
            <li>整数の計算。</li>
            <li>REPL (Read-Eval-Print Loop) 形式での対話的実行。</li>
        </ul>

        <h2 id="token">Step 1: トークン定義</h2>
        <p>まずは、入力文字列を意味のある単位（トークン）に分解するための型を定義します。<br>
            LuneScript の <code>alge</code> (Algebric Data Type) が最適です。</p>

        <pre><code class="language-lns"><span class="comment">// @lnsFront: skip</span>
<span class="comment">// Token 型の定義</span>
<span class="keyword">alge</span> Token {
    Num( val: <span class="type">int</span> ),      <span class="comment">// 数字: 123</span>
    Op( val: <span class="type">str</span> ),       <span class="comment">// 演算子: +, -, *, / (, )</span>
    Eof,                  <span class="comment">// 文字列の終端</span>
}
</code></pre>

        <h2 id="lexer">Step 2: 字句解析 (Lexer)</h2>
        <p>文字列を読み取って <code>Token</code> を生成する <code>Lexer</code> クラスを作成します。</p>
        <pre><code class="language-lns"><span class="comment">// @lnsFront: skip</span>
<span class="keyword">class</span> Lexer {
    <span class="keyword">let</span> text: <span class="type">str</span>;
    <span class="keyword">let</span> len: <span class="type">int</span>;
    <span class="keyword">let</span> <span class="keyword">mut</span> pos: <span class="type">int</span>;

    <span class="keyword">pub</span> <span class="keyword">fn</span> __init( text:<span class="type">str</span> ) {
        <span class="keyword">self</span>.text = text;
        <span class="keyword">self</span>.len = #text;
        <span class="keyword">self</span>.pos = <span class="number">1</span>;
    }

    <span class="comment">// 現在の文字を取得 (範囲外なら 0 の文字コード)</span>
    <span class="keyword">fn</span> getChar(): <span class="type">int</span> {
        <span class="keyword">if</span> <span class="keyword">self</span>.pos &gt; <span class="keyword">self</span>.len { <span class="keyword">return</span> <span class="number">0</span>; }
        <span class="keyword">return</span> <span class="keyword">self</span>.text.byte( <span class="keyword">self</span>.pos );
    }

    <span class="comment">// 次のトークンを取得</span>
    <span class="keyword">pub</span> <span class="keyword">fn</span> next() <span class="keyword">mut</span>: Token {
        <span class="comment">// 空白スキップ</span>
        <span class="keyword">while</span> <span class="keyword">self</span>.getChar() == ?  {
            <span class="keyword">self</span>.pos = <span class="keyword">self</span>.pos + <span class="number">1</span>;
        }
        
        <span class="keyword">let</span> ch = <span class="keyword">self</span>.getChar();
        <span class="keyword">if</span> ch == <span class="number">0</span> { <span class="keyword">return</span> .Eof; }

        <span class="comment">// 数字の場合</span>
        <span class="keyword">if</span> ch &gt;= ?<span class="number">0</span> and ch &lt;= ?<span class="number">9</span> {
            <span class="keyword">let</span> <span class="keyword">mut</span> numVal = <span class="number">0</span>;
            <span class="keyword">while</span> <span class="keyword">true</span> {
                <span class="keyword">let</span> cur = <span class="keyword">self</span>.getChar();
                <span class="keyword">if</span> cur &lt; ?<span class="number">0</span> or cur &gt; ?<span class="number">9</span> { <span class="keyword">break</span>; }
                numVal = numVal * <span class="number">10</span> + ( cur - ?<span class="number">0</span> );
                <span class="keyword">self</span>.pos = <span class="keyword">self</span>.pos + <span class="number">1</span>;
            }
            <span class="keyword">return</span> Token.Num( numVal );
        }

        <span class="comment">// 演算子の場合</span>
        <span class="keyword">self</span>.pos = <span class="keyword">self</span>.pos + <span class="number">1</span>;
        <span class="keyword">return</span> Token.Op( <span class="string">"%c"</span> ( ch ) );
    }
}
</code></pre>
        <div class="note">
            <code>?</code> は文字コードリテラルです (<code>?A</code> は 65)。
        </div>

        <h2 id="ast">Step 3: 構文木 (AST) の定義</h2>
        <p>構文解析の結果を格納する木構造を定義します。ここでも <code>alge</code> が活躍します。</p>
        <pre><code class="language-lns"><span class="comment">// @lnsFront: skip</span>
<span class="keyword">alge</span> Ast {
    Val( val: <span class="type">int</span> ),                      <span class="comment">// 数値</span>
    Bin( op: <span class="type">str</span>, left: Ast, right: Ast ), <span class="comment">// 二項演算 (左辺 op 右辺)</span>
}
</code></pre>

        <h2 id="parser">Step 4: 構文解析 (Parser)</h2>
        <p>再帰下降構文解析法 (Recursive Descent Parsing) を用いて、トークン列を AST に変換します。<br>
            優先順位を扱うため、<code>Expr</code> (式), <code>Term</code> (項), <code>Factor</code> (因子) にメソッドを分割します。</p>

        <pre><code class="language-lns"><span class="comment">// @lnsFront: skip</span>
<span class="keyword">class</span> Parser {
    <span class="keyword">let</span> <span class="keyword">mut</span> lexer: Lexer;
    <span class="keyword">let</span> <span class="keyword">mut</span> cur: Token;

    <span class="keyword">pub</span> <span class="keyword">fn</span> __init( text: <span class="type">str</span> ) {
        <span class="keyword">self</span>.lexer = <span class="keyword">new</span> Lexer( text );
        <span class="keyword">self</span>.cur = <span class="keyword">self</span>.lexer.next();
    }

    <span class="comment">// トークンを進める</span>
    <span class="keyword">fn</span> next() <span class="keyword">mut</span> {
        <span class="keyword">self</span>.cur = <span class="keyword">self</span>.lexer.next();
    }

    <span class="comment">// 因子: 数値 または (式)</span>
    <span class="keyword">fn</span> parseFactor() <span class="keyword">mut</span>: Ast {
        <span class="keyword">match</span> <span class="keyword">self</span>.cur {
            <span class="keyword">case</span> .Num( val ) {
                <span class="keyword">self</span>.next();
                <span class="keyword">return</span> .Val( val );
            }
            <span class="keyword">case</span> .Op( op ) {
                <span class="keyword">if</span> op == <span class="string">"("</span> {
                    <span class="keyword">self</span>.next();
                    <span class="keyword">let</span> node = <span class="keyword">self</span>.parseExpr();
                    <span class="keyword">match</span> <span class="keyword">self</span>.cur {
                       <span class="keyword">case</span> .Op( nextOp ) {
                           <span class="keyword">if</span> nextOp == <span class="string">")"</span> {
                               <span class="keyword">self</span>.next();
                               <span class="keyword">return</span> node;
                           }
                       }
                       <span class="keyword">default</span> {}
                    }
                    print( <span class="string">"Error: missing )"</span> );
                    <span class="keyword">return</span> node;
                }
            }
            <span class="keyword">default</span> {
                print( <span class="string">"Error: unexpected token"</span> );
            }
        }
        <span class="keyword">return</span> .Val( <span class="number">0</span> );
    }

    <span class="comment">// 項: 掛け算、割り算</span>
    <span class="keyword">fn</span> parseTerm() <span class="keyword">mut</span>: Ast {
        <span class="keyword">let</span> <span class="keyword">mut</span> left = <span class="keyword">self</span>.parseFactor();
        <span class="keyword">while</span> <span class="keyword">true</span> {
            <span class="keyword">match</span> <span class="keyword">self</span>.cur {
                <span class="keyword">case</span> .Op( op ) {
                    <span class="keyword">if</span> op == <span class="string">"*"</span> or op == <span class="string">"/"</span> {
                        <span class="keyword">self</span>.next();
                        <span class="keyword">let</span> right = <span class="keyword">self</span>.parseFactor();
                        left = .Bin( op, left, right );
                    } <span class="keyword">else</span> {
                        <span class="keyword">break</span>;
                    }
                }
                <span class="keyword">default</span> { <span class="keyword">break</span>; }
            }
        }
        <span class="keyword">return</span> left;
    }

    <span class="comment">// 式: 足し算、引き算</span>
    <span class="keyword">pub</span> <span class="keyword">fn</span> parseExpr() <span class="keyword">mut</span>: Ast {
        <span class="keyword">let</span> <span class="keyword">mut</span> left = <span class="keyword">self</span>.parseTerm();
        <span class="keyword">while</span> <span class="keyword">true</span> {
            <span class="keyword">match</span> <span class="keyword">self</span>.cur {
                <span class="keyword">case</span> .Op( op ) {
                    <span class="keyword">if</span> op == <span class="string">"+"</span> or op == <span class="string">"-"</span> {
                        <span class="keyword">self</span>.next();
                        <span class="keyword">let</span> right = <span class="keyword">self</span>.parseTerm();
                        left = .Bin( op, left, right );
                    } <span class="keyword">else</span> {
                        <span class="keyword">break</span>;
                    }
                }
                <span class="keyword">default</span> { <span class="keyword">break</span>; }
            }
        }
        <span class="keyword">return</span> left;
    }
}
</code></pre>

        <h2 id="eval">Step 5: 評価と実行</h2>
        <p>最後に、生成された AST を再帰的に処理して計算結果を求める関数を作成します。<br>
            <code>match</code> 式を使うことで、簡潔に記述できます。
        </p>

        <pre><code class="language-lns"><span class="comment">// @lnsFront: skip</span>
<span class="keyword">fn</span> eval( node: Ast ): <span class="type">int</span> {
    <span class="keyword">match</span> node {
        <span class="keyword">case</span> .Val( val ) {
            <span class="keyword">return</span> val;
        }
        <span class="keyword">case</span> .Bin( op, left, right ) {
            <span class="keyword">let</span> l = eval( left );
            <span class="keyword">let</span> r = eval( right );
            <span class="keyword">switch</span> op {
                <span class="keyword">case</span> <span class="string">"+"</span> { <span class="keyword">return</span> l + r; }
                <span class="keyword">case</span> <span class="string">"-"</span> { <span class="keyword">return</span> l - r; }
                <span class="keyword">case</span> <span class="string">"*"</span> { <span class="keyword">return</span> l * r; }
                <span class="keyword">case</span> <span class="string">"/"</span> { <span class="keyword">return</span> l / r; }
            }
        }
    }
    <span class="keyword">return</span> <span class="number">0</span>;
}

<span class="comment">// メイン処理</span>
<span class="keyword">let</span> input = <span class="string">"1 + 2 * (3 + 4)"</span>;
<span class="keyword">let</span> <span class="keyword">mut</span> parser = <span class="keyword">new</span> Parser( input );
<span class="keyword">let</span> ast = parser.parseExpr();
print( <span class="string">"%s = %d"</span> ( input, eval( ast ) ) );
</code></pre>
        <p>これを実行すると <code>1 + 2 * (3 + 4) = 15</code> が出力されます！</p>

        <hr>
        <h3>完成コード</h3>
        <p>すべてのコードをまとめたものが以下になります。</p>
        <pre><code class="language-lns"><span class="keyword">alge</span> Token {
    Num( val: <span class="type">int</span> ),
    Op( val: <span class="type">str</span> ),
    Eof,
}

<span class="keyword">class</span> Lexer {
    <span class="keyword">let</span> text: <span class="type">str</span>;
    <span class="keyword">let</span> len: <span class="type">int</span>;
    <span class="keyword">let</span> <span class="keyword">mut</span> pos: <span class="type">int</span>;

    <span class="keyword">pub</span> <span class="keyword">fn</span> __init( text:<span class="type">str</span> ) {
        <span class="keyword">self</span>.text = text;
        <span class="keyword">self</span>.len = #text;
        <span class="keyword">self</span>.pos = <span class="number">1</span>;
    }

    <span class="keyword">fn</span> getChar(): <span class="type">int</span> {
        <span class="keyword">if</span> <span class="keyword">self</span>.pos &gt; <span class="keyword">self</span>.len { <span class="keyword">return</span> <span class="number">0</span>; }
        <span class="keyword">return</span> <span class="keyword">unwrap</span> <span class="keyword">self</span>.text.byte( <span class="keyword">self</span>.pos ) <span class="keyword">default</span> <span class="number">0</span>;
    }

    <span class="keyword">pub</span> <span class="keyword">fn</span> next() <span class="keyword">mut</span>: Token {
        <span class="keyword">while</span> <span class="keyword">self</span>.getChar() == ?  {
            <span class="keyword">self</span>.pos = <span class="keyword">self</span>.pos + <span class="number">1</span>;
        }
        
        <span class="keyword">let</span> ch = <span class="keyword">self</span>.getChar();
        <span class="keyword">if</span> ch == <span class="number">0</span> { <span class="keyword">return</span> .Eof; }

        <span class="keyword">if</span> ch &gt;= ?<span class="number">0</span> and ch &lt;= ?<span class="number">9</span> {
            <span class="keyword">let</span> <span class="keyword">mut</span> numVal = <span class="number">0</span>;
            <span class="keyword">while</span> <span class="keyword">true</span> {
                <span class="keyword">let</span> cur = <span class="keyword">self</span>.getChar();
                <span class="keyword">if</span> cur &lt; ?<span class="number">0</span> or cur &gt; ?<span class="number">9</span> { <span class="keyword">break</span>; }
                numVal = numVal * <span class="number">10</span> + ( cur - ?<span class="number">0</span> );
                <span class="keyword">self</span>.pos = <span class="keyword">self</span>.pos + <span class="number">1</span>;
            }
            <span class="keyword">return</span> Token.Num( numVal );
        }

        <span class="keyword">self</span>.pos = <span class="keyword">self</span>.pos + <span class="number">1</span>;
        <span class="keyword">return</span> Token.Op( <span class="string">"%c"</span> ( ch ) );
    }
}

<span class="keyword">alge</span> Ast {
    Val( val: <span class="type">int</span> ),
    Bin( op: <span class="type">str</span>, left: Ast, right: Ast ),
}

<span class="keyword">class</span> Parser {
    <span class="keyword">let</span> <span class="keyword">mut</span> lexer: Lexer;
    <span class="keyword">let</span> <span class="keyword">mut</span> cur: Token;

    <span class="keyword">pub</span> <span class="keyword">fn</span> __init( text: <span class="type">str</span> ) {
        <span class="keyword">self</span>.lexer = <span class="keyword">new</span> Lexer( text );
        <span class="keyword">self</span>.cur = <span class="keyword">self</span>.lexer.next();
    }

    <span class="keyword">fn</span> next() <span class="keyword">mut</span> {
        <span class="keyword">self</span>.cur = <span class="keyword">self</span>.lexer.next();
    }

    <span class="keyword">fn</span> parseFactor() <span class="keyword">mut</span>: Ast {
        <span class="keyword">match</span> <span class="keyword">self</span>.cur {
            <span class="keyword">case</span> .Num( val ) {
                <span class="keyword">self</span>.next();
                <span class="keyword">return</span> .Val( val );
            }
            <span class="keyword">case</span> .Op( op ) {
                <span class="keyword">if</span> op == <span class="string">"("</span> {
                    <span class="keyword">self</span>.next();
                    <span class="keyword">let</span> node = <span class="keyword">self</span>.parseExpr();
                    <span class="keyword">match</span> <span class="keyword">self</span>.cur {
                       <span class="keyword">case</span> .Op( nextOp ) {
                           <span class="keyword">if</span> nextOp == <span class="string">")"</span> {
                               <span class="keyword">self</span>.next();
                               <span class="keyword">return</span> node;
                           }
                       }
                       <span class="keyword">default</span> {}
                    }
                    print( <span class="string">"Error: missing )"</span> );
                    <span class="keyword">return</span> node;
                }
            }
            <span class="keyword">default</span> {
                print( <span class="string">"Error: unexpected token"</span> );
            }
        }
        <span class="keyword">return</span> .Val( <span class="number">0</span> );
    }

    <span class="keyword">fn</span> parseTerm() <span class="keyword">mut</span>: Ast {
        <span class="keyword">let</span> <span class="keyword">mut</span> left = <span class="keyword">self</span>.parseFactor();
        <span class="keyword">while</span> <span class="keyword">true</span> {
            <span class="keyword">match</span> <span class="keyword">self</span>.cur {
                <span class="keyword">case</span> .Op( op ) {
                    <span class="keyword">if</span> op == <span class="string">"*"</span> or op == <span class="string">"/"</span> {
                        <span class="keyword">self</span>.next();
                        <span class="keyword">let</span> right = <span class="keyword">self</span>.parseFactor();
                        left = .Bin( op, left, right );
                    } <span class="keyword">else</span> {
                        <span class="keyword">break</span>;
                    }
                }
                <span class="keyword">default</span> { <span class="keyword">break</span>; }
            }
        }
        <span class="keyword">return</span> left;
    }

    <span class="keyword">pub</span> <span class="keyword">fn</span> parseExpr() <span class="keyword">mut</span>: Ast {
        <span class="keyword">let</span> <span class="keyword">mut</span> left = <span class="keyword">self</span>.parseTerm();
        <span class="keyword">while</span> <span class="keyword">true</span> {
            <span class="keyword">match</span> <span class="keyword">self</span>.cur {
                <span class="keyword">case</span> .Op( op ) {
                    <span class="keyword">if</span> op == <span class="string">"+"</span> or op == <span class="string">"-"</span> {
                        <span class="keyword">self</span>.next();
                        <span class="keyword">let</span> right = <span class="keyword">self</span>.parseTerm();
                        left = .Bin( op, left, right );
                    } <span class="keyword">else</span> {
                        <span class="keyword">break</span>;
                    }
                }
                <span class="keyword">default</span> { <span class="keyword">break</span>; }
            }
        }
        <span class="keyword">return</span> left;
    }
}

<span class="keyword">fn</span> eval( node: Ast ): <span class="type">int</span> {
    <span class="keyword">match</span> node {
        <span class="keyword">case</span> .Val( val ) {
            <span class="keyword">return</span> val;
        }
        <span class="keyword">case</span> .Bin( op, left, right ) {
            <span class="keyword">let</span> l = eval( left );
            <span class="keyword">let</span> r = eval( right );
            <span class="keyword">switch</span> op {
                <span class="keyword">case</span> <span class="string">"+"</span> { <span class="keyword">return</span> l + r; }
                <span class="keyword">case</span> <span class="string">"-"</span> { <span class="keyword">return</span> l - r; }
                <span class="keyword">case</span> <span class="string">"*"</span> { <span class="keyword">return</span> l * r; }
                <span class="keyword">case</span> <span class="string">"/"</span> { <span class="keyword">return</span> l / r; }
            }
        }
    }
    <span class="keyword">return</span> <span class="number">0</span>;
}

<span class="comment">// メイン処理</span>
<span class="keyword">let</span> input = <span class="string">"1 + 2 * (3 + 4)"</span>;
<span class="keyword">let</span> <span class="keyword">mut</span> parser = <span class="keyword">new</span> Parser( input );
<span class="keyword">let</span> ast = parser.parseExpr();
print( <span class="string">"%s = %d"</span> ( input, eval( ast ) ) );
</code></pre>

    </div>
</body>

</html>