<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuneScript Guide - Macros</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
</head>

<body>
    <div class="sidebar">
        <h1>LuneScript Guide</h1>
        <ul class="nav-links">
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="index.html">Introduction</a>
                <ul class="submenu">
                    <li><a href="index.html#features">Key Features</a></li>
                    <li><a href="index.html#audience">Target Audience</a></li>
                    <li><a href="index.html#license">License</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="learning.html">Learning Guide</a>
                <ul class="submenu">
                    <li><a href="learning.html#step1">Step 1: Basics</a></li>
                    <li><a href="learning.html#step2">Step 2: Safety Features</a></li>
                    <li><a href="learning.html#step3">Step 3: Modern Features</a></li>
                    <li><a href="learning.html#navigation">Using Documentation</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial.html">Installation and Hello World</a>
                <ul class="submenu">
                    <li><a href="tutorial.html#install">Installation</a></li>
                    <li><a href="tutorial.html#hello">Hello World</a></li>
                    <li><a href="tutorial.html#options">lnsc Command</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="syntax.html">Basic Syntax</a>
                <ul class="submenu">
                    <li><a href="syntax.html#comments">Comments</a></li>
                    <li><a href="syntax.html#vars">Variable Declarations</a></li>
                    <li><a href="syntax.html#flow">Initialization by Flow Analysis</a></li>
                    <li><a href="syntax.html#scope">Scope Blocks</a></li>
                    <li><a href="syntax.html#attr">Attributes</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="value.html">Values and Types</a>
                <ul class="submenu">
                    <li><a href="value.html#primitive">Primitive Types</a></li>
                    <li><a href="value.html#collection">Collections</a></li>
                    <li><a href="value.html#list">&nbsp;&nbsp;List</a></li>
                    <li><a href="value.html#map">&nbsp;&nbsp;Map</a></li>
                    <li><a href="value.html#set">&nbsp;&nbsp;Set</a></li>
                    <li><a href="value.html#nilable">Nilable Types</a></li>
                    <li><a href="value.html#cast">Casting</a></li>
                    <li><a href="value.html#alge">Algebraic Data Types</a></li>
                    <li><a href="value.html#enum">Enum</a></li>
                    <li><a href="value.html#tuple">Tuple</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="control.html">Control Flow</a>
                <ul class="submenu">
                    <li><a href="control.html#if">if statement</a></li>
                    <li><a href="control.html#switch">switch statement</a></li>
                    <li><a href="control.html#while">while statement</a></li>
                    <li><a href="control.html#repeat">repeat statement</a></li>
                    <li><a href="control.html#for">for statement</a></li>
                    <li><a href="control.html#foreach">foreach statement</a></li>
                    <li><a href="control.html#apply">apply statement</a></li>
                    <li><a href="control.html#match">match statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="error.html">Error Handling</a>
                <ul class="submenu">
                    <li><a href="error.html#ret">__Ret Type</a></li>
                    <li><a href="error.html#delegation">Error Delegation</a></li>
                    <li><a href="error.html#best_practice">Types and Best Practices</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="function.html">Functions</a>
                <ul class="submenu">
                    <li><a href="function.html#def">Definition</a></li>
                    <li><a href="function.html#multi_ret">Multiple Returns</a></li>
                    <li><a href="function.html#closure">Closures</a></li>
                    <li><a href="function.html#form">Form (Function Type)</a></li>
                    <li><a href="function.html#varargs">Variable Arguments</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="class.html">Classes</a>
                <ul class="submenu">
                    <li><a href="class.html#def">Definition and Instantiation</a></li>
                    <li><a href="class.html#inherit">Inheritance and Overriding</a></li>
                    <li><a href="class.html#abstract">Abstract Classes</a></li>
                    <li><a href="class.html#interface">Interfaces</a></li>
                    <li><a href="class.html#advertise">Advertise</a></li>
                    <li><a href="class.html#mapping">Mapping</a></li>
                    <li><a href="class.html#proto">Prototype Declarations</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="generics.html">Generics</a>
                <ul class="submenu">
                    <li><a href="generics.html#func">Function Generics</a></li>
                    <li><a href="generics.html#class">Class Generics</a></li>
                    <li><a href="generics.html#constraint">Type Parameter Constraints</a></li>
                    <li><a href="generics.html#method">Method Generics</a></li>
                    <li><a href="generics.html#mut">Generics and Mutability</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="macro.html">Macros</a>
                <ul class="submenu">
                    <li><a href="macro.html#def">Definition</a></li>
                    <li><a href="macro.html#arg">Arguments</a></li>
                    <li><a href="macro.html#quote">Quoting</a></li>
                    <li><a href="macro.html#statement">Macro Statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="advanced.html">Advanced Features</a>
                <ul class="submenu">
                    <li><a href="advanced.html#match">Pattern Matching</a></li>
                    <li><a href="advanced.html#async">Asynchronous Processing</a></li>
                    <li><a href="advanced.html#glue">Glue Code</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="module.html">Modules and Projects</a>
                <ul class="submenu">
                    <li><a href="module.html#module">Module System</a></li>
                    <li><a href="module.html#project">Project Settings</a></li>
                    <li><a href="module.html#provide">Provide</a></li>
                    <li><a href="module.html#require">Require</a></li>
                    <li><a href="module.html#subfile">Subfile</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="standard.html">Standard Library</a>
                <ul class="submenu">
                    <li><a href="standard.html#builtin">Built-in Functions</a></li>
                    <li><a href="standard.html#lua">Lua Standard Library</a></li>
                    <li><a href="standard.html#io">IO</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_macro.html">Practical: Macro Usage</a>
                <ul class="submenu">
                    <li><a href="tutorial_macro.html#step1">Step 1: Debug Print</a></li>
                    <li><a href="tutorial_macro.html#step2">Step 2: Assertion</a></li>
                    <li><a href="tutorial_macro.html#step3">Step 3: Measurement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_parser.html">Practical: Expression Parser</a>
                <ul class="submenu">
                    <li><a href="tutorial_parser.html#goal">Goal</a></li>
                    <li><a href="tutorial_parser.html#token">Step 1: Token Definition</a></li>
                    <li><a href="tutorial_parser.html#lexer">Step 2: Lexical Analysis</a></li>
                    <li><a href="tutorial_parser.html#ast">Step 3: Abstract Syntax Tree (AST)</a></li>
                    <li><a href="tutorial_parser.html#parser">Step 4: Parsing</a></li>
                    <li><a href="tutorial_parser.html#eval">Step 5: Evaluation and Execution</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="keyword.html">Keywords List</a>
                <ul class="submenu">
                    <li><a href="keyword.html#a">A-G</a></li>
                    <li><a href="keyword.html#h">H-N</a></li>
                    <li><a href="keyword.html#o">O-U</a></li>
                    <li><a href="keyword.html#v">V-Z</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="troubleshooting.html">Troubleshooting</a>
                <ul class="submenu">
                    <li><a href="troubleshooting.html#char">Character Literals</a></li>
                    <li><a href="troubleshooting.html#mut">Mutable Methods</a></li>
                    <li><a href="troubleshooting.html#match">Pattern Matching</a></li>
                    <li><a href="troubleshooting.html#unwrap">Nilable Operations</a></li>
                    <li><a href="troubleshooting.html#macro">Macro Syntax Errors</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="evaluation.html">Discussion and Evaluation</a>
                <ul class="submenu">
                    <li><a href="evaluation.html#quality">Language Quality</a></li>
                    <li><a href="evaluation.html#vs-lua">Comparison with Lua</a></li>
                    <li><a href="evaluation.html#vs-teal">Comparison with Teal</a></li>
                    <li><a href="evaluation.html#issues">Issues and Proposals</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="main-content">
    <div class="header-nav">
        <a href="../ja/macro.html" class="lang-link">日本語</a>
    </div>
        <h1>Macros</h1>
        <p>LuneScript macros are a powerful feature that expands and generates code (AST) at compile time.</p>

        <h2 id="def">Definition</h2>
        <p>Defined using the <code>macro</code> keyword. By convention, macro names begin with an underscore
            <code>_</code>.</p>
        <pre><code class="language-lns"><span class="keyword">macro</span> _dprint( exp: __exp ) {
    print( <span class="string">"DEBUG:"</span>, ,,exp );
}
</code></pre>

        <h2 id="arg">Arguments</h2>
        <p>In addition to regular types, you can specify macro-specific types for macro arguments.</p>
        <ul>
            <li><code>__exp</code>: Receives the expression itself. The most versatile type.</li>
            <li><code>sym</code>: Receives a symbol (variable name, function name, etc.).</li>
            <li><code>__block</code>: Receives a code block <code>{ ... }</code>.</li>
        </ul>
        <pre><code class="language-lns"><span class="keyword">macro</span> _assign( symbol: sym, val: <span class="type">int</span> ) {
    ,,symbol = ,,val;
}
<span class="keyword">let</span> <span class="keyword">mut</span> val = <span class="number">0</span>;
_assign( val, <span class="number">10</span> ); <span class="comment">// Expanded as val = 10;</span>
</code></pre>

        <h2 id="quote">Quoting (Expansion Operators)</h2>
        <p>When using arguments in the macro body (expand-statement), use the following operators to control expansion.
        </p>
        <table>
            <thead>
                <tr>
                    <th>Operator</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>,,</code></td>
                    <td>Expands the value of the argument directly as code.</td>
                </tr>
                <tr>
                    <td><code>,,,</code></td>
                    <td>Expands the string value of the argument as a <strong>symbol name</strong>.</td>
                </tr>
                <tr>
                    <td><code>,,,,</code></td>
                    <td>Converts the symbol name of the argument into a <strong>string literal</strong> and expands it.
                    </td>
                </tr>
            </tbody>
        </table>

        <pre><code class="language-lns"><span class="keyword">pub</span> <span class="keyword">macro</span> _hello( name: <span class="type">str</span> ) {
    print( <span class="string">"Hello, "</span>, ,,name );
}
</code></pre>

        <h2 id="statement">Macro Statement</h2>
        <p>A macro definition consists of a <code>macro-statement</code> (the first <code>{}</code>) for calculations
            and preparation, and an <code>expand-statement</code> (the latter part) for generating actual code.</p>
        <p>Within the <code>macro-statement</code>, standard LuneScript calculation features can be used to determine
            the content of the expanded code dynamically. Furthermore, by using the <code>`{}</code> operator, fragments
            of code (of type <code>stat</code>) can be stored into variables and listed.</p>

        <h3>Example of Dynamic Code Generation</h3>
        <p>The following example automatically defines a series of variables by the specified count.</p>
        <pre><code class="language-lns"><span class="keyword">macro</span> _GenVars( prefix: <span class="type">str</span>, count: <span class="type">int</span> ) {
    {
        <span class="comment">// macro-statement: Create a list of code to expand</span>
        <span class="keyword">let</span> <span class="keyword">mut</span> stats: <span class="type">List&lt;stat&gt;</span> = [];
        <span class="keyword">for</span> i = <span class="number">1</span>, count {
            <span class="keyword">let</span> varName = <span class="string">"%s%d"</span> (prefix, i);
            stats.insert( <span class="keyword">`{</span>
                <span class="keyword">let</span> <span class="keyword">,,,</span><span class="string">"v_%s"</span>(varName)~~ = <span class="keyword">,,</span>i;
            <span class="keyword">}</span> );
        }
    }
    <span class="comment">// expand-statement: Expand the generated list all at once</span>
    <span class="keyword">,,</span>stats;
}

_GenVars( <span class="string">"val"</span>, <span class="number">3</span> );
<span class="comment">// Expanded as let v_val1 = 1; let v_val2 = 2; let v_val3 = 3;</span>
print( v_val1, v_val2, v_val3 ); <span class="comment">// 1 2 3</span>
</code></pre>

        <div class="note">
            <h4>Constraints within macro-statement</h4>
            <ul>
                <li>Available functions are only LuneScript standard functions (<code>print</code>,
                    <code>os.clock</code>, <code>io.open</code>, etc.).</li>
                <li>You cannot call regular functions defined within the same file (since those functions do not exist
                    yet at compile time).</li>
                <li>The special operator <code>~~</code> is used to explicitly indicate the end of the expression
                    targeted by the <code>,,,</code> operator.</li>
            </ul>
        </div>


        <div class="note">
            <h4>Caution: Conflict with Lua Reserved Words</h4>
            If a variable name in the code expanded by a macro conflicts with a Lua reserved word (such as
            <code>end</code>), an error will occur after transcompilation. Be careful with variable names used inside
            macros.
        </div>

        <div class="note">
            Macros are a complex feature, and their overuse can detract from code readability. Please use them
            appropriately.
        </div>

    </div>
</body>

</html>