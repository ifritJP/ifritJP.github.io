<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuneScript Guide - Troubleshooting</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
</head>

<body>
    <div class="sidebar">
        <h1>LuneScript Guide</h1>
        <ul class="nav-links">
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="index.html">Introduction</a>
                <ul class="submenu">
                    <li><a href="index.html#features">Key Features</a></li>
                    <li><a href="index.html#audience">Target Audience</a></li>
                    <li><a href="index.html#license">License</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="learning.html">Learning Guide</a>
                <ul class="submenu">
                    <li><a href="learning.html#step1">Step 1: Basics</a></li>
                    <li><a href="learning.html#step2">Step 2: Safety Features</a></li>
                    <li><a href="learning.html#step3">Step 3: Modern Features</a></li>
                    <li><a href="learning.html#navigation">Using Documentation</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial.html">Installation and Hello World</a>
                <ul class="submenu">
                    <li><a href="tutorial.html#install">Installation</a></li>
                    <li><a href="tutorial.html#hello">Hello World</a></li>
                    <li><a href="tutorial.html#options">lnsc Command</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="syntax.html">Basic Syntax</a>
                <ul class="submenu">
                    <li><a href="syntax.html#comments">Comments</a></li>
                    <li><a href="syntax.html#vars">Variable Declarations</a></li>
                    <li><a href="syntax.html#flow">Initialization by Flow Analysis</a></li>
                    <li><a href="syntax.html#scope">Scope Blocks</a></li>
                    <li><a href="syntax.html#attr">Attributes</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="value.html">Values and Types</a>
                <ul class="submenu">
                    <li><a href="value.html#primitive">Primitive Types</a></li>
                    <li><a href="value.html#collection">Collections</a></li>
                    <li><a href="value.html#list">&nbsp;&nbsp;List</a></li>
                    <li><a href="value.html#map">&nbsp;&nbsp;Map</a></li>
                    <li><a href="value.html#set">&nbsp;&nbsp;Set</a></li>
                    <li><a href="value.html#nilable">Nilable Types</a></li>
                    <li><a href="value.html#cast">Casting</a></li>
                    <li><a href="value.html#alge">Algebraic Data Types</a></li>
                    <li><a href="value.html#enum">Enum</a></li>
                    <li><a href="value.html#tuple">Tuple</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="control.html">Control Flow</a>
                <ul class="submenu">
                    <li><a href="control.html#if">if statement</a></li>
                    <li><a href="control.html#switch">switch statement</a></li>
                    <li><a href="control.html#while">while statement</a></li>
                    <li><a href="control.html#repeat">repeat statement</a></li>
                    <li><a href="control.html#for">for statement</a></li>
                    <li><a href="control.html#foreach">foreach statement</a></li>
                    <li><a href="control.html#apply">apply statement</a></li>
                    <li><a href="control.html#match">match statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="error.html">Error Handling</a>
                <ul class="submenu">
                    <li><a href="error.html#ret">__Ret Type</a></li>
                    <li><a href="error.html#delegation">Error Delegation</a></li>
                    <li><a href="error.html#best_practice">Types and Best Practices</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="function.html">Functions</a>
                <ul class="submenu">
                    <li><a href="function.html#def">Definition</a></li>
                    <li><a href="function.html#multi_ret">Multiple Returns</a></li>
                    <li><a href="function.html#closure">Closures</a></li>
                    <li><a href="function.html#form">Form (Function Type)</a></li>
                    <li><a href="function.html#varargs">Variable Arguments</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="class.html">Classes</a>
                <ul class="submenu">
                    <li><a href="class.html#def">Definition and Instantiation</a></li>
                    <li><a href="class.html#inherit">Inheritance and Overriding</a></li>
                    <li><a href="class.html#abstract">Abstract Classes</a></li>
                    <li><a href="class.html#interface">Interfaces</a></li>
                    <li><a href="class.html#advertise">Advertise</a></li>
                    <li><a href="class.html#mapping">Mapping</a></li>
                    <li><a href="class.html#proto">Prototype Declarations</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="generics.html">Generics</a>
                <ul class="submenu">
                    <li><a href="generics.html#func">Function Generics</a></li>
                    <li><a href="generics.html#class">Class Generics</a></li>
                    <li><a href="generics.html#constraint">Type Parameter Constraints</a></li>
                    <li><a href="generics.html#method">Method Generics</a></li>
                    <li><a href="generics.html#mut">Generics and Mutability</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="macro.html">Macros</a>
                <ul class="submenu">
                    <li><a href="macro.html#def">Definition</a></li>
                    <li><a href="macro.html#arg">Arguments</a></li>
                    <li><a href="macro.html#quote">Quoting</a></li>
                    <li><a href="macro.html#statement">Macro Statement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="advanced.html">Advanced Features</a>
                <ul class="submenu">
                    <li><a href="advanced.html#match">Pattern Matching</a></li>
                    <li><a href="advanced.html#async">Asynchronous Processing</a></li>
                    <li><a href="advanced.html#glue">Glue Code</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="module.html">Modules and Projects</a>
                <ul class="submenu">
                    <li><a href="module.html#module">Module System</a></li>
                    <li><a href="module.html#project">Project Settings</a></li>
                    <li><a href="module.html#provide">Provide</a></li>
                    <li><a href="module.html#require">Require</a></li>
                    <li><a href="module.html#subfile">Subfile</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="standard.html">Standard Library</a>
                <ul class="submenu">
                    <li><a href="standard.html#builtin">Built-in Functions</a></li>
                    <li><a href="standard.html#lua">Lua Standard Library</a></li>
                    <li><a href="standard.html#io">IO</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_macro.html">Practical: Macro Usage</a>
                <ul class="submenu">
                    <li><a href="tutorial_macro.html#step1">Step 1: Debug Print</a></li>
                    <li><a href="tutorial_macro.html#step2">Step 2: Assertion</a></li>
                    <li><a href="tutorial_macro.html#step3">Step 3: Measurement</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="tutorial_parser.html">Practical: Expression Parser</a>
                <ul class="submenu">
                    <li><a href="tutorial_parser.html#goal">Goal</a></li>
                    <li><a href="tutorial_parser.html#token">Step 1: Token Definition</a></li>
                    <li><a href="tutorial_parser.html#lexer">Step 2: Lexical Analysis</a></li>
                    <li><a href="tutorial_parser.html#ast">Step 3: Abstract Syntax Tree (AST)</a></li>
                    <li><a href="tutorial_parser.html#parser">Step 4: Parsing</a></li>
                    <li><a href="tutorial_parser.html#eval">Step 5: Evaluation and Execution</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="keyword.html">Keywords List</a>
                <ul class="submenu">
                    <li><a href="keyword.html#a">A-G</a></li>
                    <li><a href="keyword.html#h">H-N</a></li>
                    <li><a href="keyword.html#o">O-U</a></li>
                    <li><a href="keyword.html#v">V-Z</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="troubleshooting.html">Troubleshooting</a>
                <ul class="submenu">
                    <li><a href="troubleshooting.html#char">Character Literals</a></li>
                    <li><a href="troubleshooting.html#mut">Mutable Methods</a></li>
                    <li><a href="troubleshooting.html#match">Pattern Matching</a></li>
                    <li><a href="troubleshooting.html#unwrap">Nilable Operations</a></li>
                    <li><a href="troubleshooting.html#macro">Macro Syntax Errors</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <button class="toggle-btn">▶</button>
                <a href="evaluation.html">Discussion and Evaluation</a>
                <ul class="submenu">
                    <li><a href="evaluation.html#quality">Language Quality</a></li>
                    <li><a href="evaluation.html#vs-lua">Comparison with Lua</a></li>
                    <li><a href="evaluation.html#vs-teal">Comparison with Teal</a></li>
                    <li><a href="evaluation.html#issues">Issues and Proposals</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="main-content">
    <div class="header-nav">
        <a href="../ja/troubleshooting.html" class="lang-link">日本語</a>
    </div>
        <h1>Troubleshooting & Common Mistakes</h1>
        <p>We have summarized errors that are easy to encounter while learning LuneScript and their solutions.<br>
            This focuses on points where experienced users of other languages (especially Lua, Go, Rust, etc.) are
            likely to get stuck.</p>

        <h2 id="char">Character Literal Syntax</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Using single quotes</p>
                <pre><code class="language-lns">// Error
let c = 'a';
let c = ?'a';
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Write the character immediately after <code>?</code></p>
                <pre><code class="language-lns">// Becomes character code (int)
let c = ?a;
let sp = ? ;    // Same for space
let zero = ?0;  // Character code for the digit
                </code></pre>
                <p>In LuneScript, character literals are treated as integer values (character codes).</p>
            </div>
        </div>

        <h2 id="mut">Mutable Method Definition</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Prefixing with <code>mut</code></p>
                <pre><code class="language-lns">class MyClass {
    let mut val: int;
    // Error: illegal field or method declaration
    pub mut fn inc() {
        self.val = self.val + 1;
    }
}
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Place <code>mut</code> after the argument list</p>
                <pre><code class="language-lns">class MyClass {
    let mut val: int;
    // Indicates that the method modifies itself (self)
    pub fn inc() mut {
        self.val = self.val + 1;
    }
}
                </code></pre>
                <p>In method definitions, <code>mut</code> functions as a declaration of the side effect 'this method
                    modifies <code>self</code>', so it is written as part of the signature (on the trailing side).<br>
                    Note that if there is a return value, it comes before the return type, like
                    <code>pub fn func() mut : int</code>.</p>
            </div>
        </div>

        <h2 id="match">Pattern Matching of ADTs</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Trying to use <code>if let</code> (Rust style)</p>
                <pre><code class="language-lns">// Error: illegal exp
if let .Val( v ) = val {
    print( v );
}
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Use the <code>match</code> statement</p>
                <pre><code class="language-lns">match val {
    case .Val( v ) {
        print( v );
    }
    default {
        // Handling when no match is found
    }
}
                </code></pre>
                <p>In the current version of LuneScript, using the <code>match</code> statement is the standard way to
                    decompose Algebraic Data Types (ADTs).</p>
            </div>
        </div>

        <h2 id="unwrap">Manipulation of Nilable Types and unwrap</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Treating Nilable types as Non-nilable directly</p>
                <pre><code class="language-lns">let val: int! = 10;
// Error: type mismatch int! (nilable) to int
let num: int = val; 
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Use <code>unwrap</code> to extract values safely</p>
                <pre><code class="language-lns">let val: int! = 10;
// Specify a default value if it is nil
let num: int = unwrap val default 0;

// Or narrow it down with if let
if let v = val {
    print( v ); // Here v is of type int
}
                </code></pre>
                <p><code>unwrap</code> is used to either 'guarantee that the value is not nil' or 'provide an
                    alternative value if it is nil'.</p>
            </div>
        </div>

        <h2 id="macro">Macro Syntax Errors</h2>
        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Forgetting the expansion operator <code>,,</code></p>
                <pre><code class="language-lns">macro _dprint( val: __exp ) {
    print( val ); // Error: val is of type __exp and cannot be used as is.
}
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Use <code>,,</code> to expand the expression</p>
                <pre><code class="language-lns">macro _dprint( val: __exp ) {
    print( ,,val ); // OK: Expression is expanded
}
                </code></pre>
                <p>To use macro arguments (<code>__exp</code>, <code>sym</code>, <code>__block</code>, etc.) within the
                    code, they must always be expanded with <code>,,</code>.</p>
            </div>
        </div>

        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Using Lua keywords as symbol names</p>
                <pre><code class="language-lns">macro _measure( block: __block ) {
    {}
    {
        let start = os.clock();
        ,,block
        let end = os.clock(); // Error: 'end' is a Lua keyword
        print( end - start );
    }
}
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Use names that avoid keywords</p>
                <p>Because LuneScript is converted to Lua, an error will occur if variable names in code expanded by
                    macros collide with Lua keywords (e.g., <code>end</code>, <code>function</code>,
                    <code>repeat</code>). Please change them to different names like <code>endTime</code>.</p>
            </div>
        </div>

        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Writing statements directly in a <code>__block</code> argument</p>
                <pre><code class="language-lns">_measure( print("hello") ); // Error: A block {} is required, not an expression
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Pass it enclosed in <code>{}</code></p>
                <pre><code class="language-lns">_measure( { print("hello"); } );
                </code></pre>
                <p>Also, in the latest LuneScript syntax, using the argument omission feature with <code>##</code>
                    instead of <code>__block</code> may be recommended. Please adjust according to compiler warnings.
                </p>
            </div>
        </div>

        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Attempting to define or call normal functions within a <code>macro-statement</code></p>
                <pre><code class="language-lns">macro _Test() {
  {
    fn createFunc( name: str ): stat { // Error
       return `{ fn ,,,name() {} };
    }
  }
  ,,createFunc("hoge");
}
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Understand that <code>macro-statement</code> is a restricted environment</p>
                <p>Within a <code>macro-statement</code> block, the type system and user-defined functions are not fully
                    available. Basically, it's safer to stick to calculations using built-in types and built-in
                    functions, and code generation with <code>`{}</code>.</p>
            </div>
        </div>

        <div class="trouble-box">
            <div class="error-case">
                <p>Mistake: Range of the <code>,,,</code> operator is unclear</p>
                <pre><code class="language-lns">stats.insert( `{
    let ,,, "v_%s"(name) = ,,i; // Error: Unclear where the name generation expression ends
} );
                </code></pre>
            </div>
            <div class="solution">
                <p>Correct: Explicitly indicate the termination with <code>~~</code></p>
                <pre><code class="language-lns">stats.insert( `{
    let ,,, "v_%s"(name) ~~ = ,,i; // OK: Tell the end of the expression with ~~
} );
                </code></pre>
                <p>The <code>,,,</code> operator, which generates symbols dynamically, often requires a <code>~~</code>
                    delimiter to prevent it from being interpreted as combined with subsequent elements.
                </p>
            </div>
        </div>


    </div>
</body>

</html>