<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go の bubbletea で簡易ターミナルエミュレータを作る - hoge blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go の bubbletea で簡易ターミナルエミュレータを作る" />
<meta property="og:description" content="CUI で動くアプリを作ると、 そのアプリ実行中に stdin からのキーボード入力を受け付けるケースが少なくない。 そして、そのキーボード入力をしたときに shell では標準的な C-a や C-f, C-b などキーが効かずにガッカリする。 そうした時に利用するのが bubbletea になる。 なお、bubbletea は go のライブラリなので、今回は go の CUI アプリを前提とする。 また、go のターミナル制御系で利用できるライブラリは他にもあるが、 今回は bubbletea を使う。 理由としては、各" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ifritjp.github.io/blog2/public/posts/2025/2025-10-05-bubbletea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-10-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2025-10-05T00:00:00+00:00" />

		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="go の bubbletea で簡易ターミナルエミュレータを作る"/>
<meta name="twitter:description" content="CUI で動くアプリを作ると、 そのアプリ実行中に stdin からのキーボード入力を受け付けるケースが少なくない。 そして、そのキーボード入力をしたときに shell では標準的な C-a や C-f, C-b などキーが効かずにガッカリする。 そうした時に利用するのが bubbletea になる。 なお、bubbletea は go のライブラリなので、今回は go の CUI アプリを前提とする。 また、go のターミナル制御系で利用できるライブラリは他にもあるが、 今回は bubbletea を使う。 理由としては、各"/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/blog2/public/css/style.css">
	

	<link rel="shortcut icon" href="/blog2/public/favicon.ico">
		
    <link rel="stylesheet" href="/blog2/public/css/highlight_lns.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
<script src="/blog2/public/js/highlight_lns.js"></script>
<script src="/blog2/public/js/hook.js"></script>
<link rel="stylesheet" href="/blog2/public/css/custom.css">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-4708B8S6ES"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4708B8S6ES');
</script>
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/blog2/public/" title="hoge blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/blog2/public/avatar.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">hoge blog</div>
					<div class="logo__tagline">生涯現役エンジニア</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/blog2/public/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/blog2/public/list.html">
				
				<span class="menu__text">Articles</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="https://ifritjp.github.io/documents/">
				
				<span class="menu__text">公開技術情報</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go の bubbletea で簡易ターミナルエミュレータを作る</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2025-10-05T00:00:00Z">2025-10-05</time></div></div>
		</header>
		
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li><a href="#headline-1">bubbletea の使い方</a>
<ul>
<li><a href="#headline-2">サンプルコード </a>
<ul>
<li><a href="#headline-3">initialModel()</a>
</li>
<li><a href="#headline-4">Update()</a>
<ul>
<li><a href="#headline-5">viewport のイベント処理について</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#headline-6">独自イベントの定義</a>
</li>
</ul>
</li>
<li><a href="#headline-7">まとめ</a>
</li>
</ul>
</nav>
	</div>
</div><div class="content post__content clearfix">
			
<p>
CUI で動くアプリを作ると、
そのアプリ実行中に stdin からのキーボード入力を受け付けるケースが少なくない。</p>
<p>
そして、そのキーボード入力をしたときに 
shell では標準的な C-a や C-f, C-b などキーが効かずにガッカリする。</p>
<p>
そうした時に利用するのが bubbletea になる。</p>
<p>
なお、bubbletea は go のライブラリなので、今回は go の CUI アプリを前提とする。</p>
<p>
また、go のターミナル制御系で利用できるライブラリは他にもあるが、
今回は bubbletea を使う。</p>
<p>
理由としては、各ライブラリのサンプルを見る限り、
自分のやりたかった事が一番簡単に出来そうだったから。</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
bubbletea の使い方
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>
bubbletea の使い方を簡単に説明する。</p>
<p>
bubbletea には、サンプルコードが複数あるが今回は次のサンプルを取り上げる。</p>
<p>
&lt;<a href="https://github.com/charmbracelet/bubbletea/tree/main/examples/chat">https://github.com/charmbracelet/bubbletea/tree/main/examples/chat</a>&gt;</p>
<p>
このサンプルは上記のリンク先を見てもらうと分かるとが、
Text を表示する領域(viewport)と、Text を入力する領域(textarea)がある。</p>
<p>
つまり、 キーボードからの入力は textarea で行ない、
アプリからの出力は viewport に行なう形になる。</p>
<div id="outline-container-headline-2" class="outline-3">
<h3 id="headline-2">
サンプルコード 
</h3>
<div id="outline-text-headline-2" class="outline-text-3">
<p>
サンプルコードの中身は以下の通り。</p>
<div class="src src-go">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// A simple program demonstrating the text area component from the Bubbles
</span></span></span><span class="line"><span class="cl"><span class="c1">// component library.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/charmbracelet/bubbles/textarea&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/charmbracelet/bubbles/viewport&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tea</span> <span class="s">&#34;github.com/charmbracelet/bubbletea&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/charmbracelet/lipgloss&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">gap</span> <span class="p">=</span> <span class="s">&#34;\n\n&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">tea</span><span class="p">.</span><span class="nf">NewProgram</span><span class="p">(</span><span class="nf">initialModel</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">errMsg</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">model</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">viewport</span>    <span class="nx">viewport</span><span class="p">.</span><span class="nx">Model</span>
</span></span><span class="line"><span class="cl">	<span class="nx">messages</span>    <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">textarea</span>    <span class="nx">textarea</span><span class="p">.</span><span class="nx">Model</span>
</span></span><span class="line"><span class="cl">	<span class="nx">senderStyle</span> <span class="nx">lipgloss</span><span class="p">.</span><span class="nx">Style</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span>         <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">initialModel</span><span class="p">()</span> <span class="nx">model</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span> <span class="o">:=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span><span class="p">.</span><span class="nx">Placeholder</span> <span class="p">=</span> <span class="s">&#34;Send a message...&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span><span class="p">.</span><span class="nf">Focus</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span><span class="p">.</span><span class="nx">Prompt</span> <span class="p">=</span> <span class="s">&#34;┃ &#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span><span class="p">.</span><span class="nx">CharLimit</span> <span class="p">=</span> <span class="mi">280</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span><span class="p">.</span><span class="nf">SetWidth</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span><span class="p">.</span><span class="nf">SetHeight</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Remove cursor line styling
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ta</span><span class="p">.</span><span class="nx">FocusedStyle</span><span class="p">.</span><span class="nx">CursorLine</span> <span class="p">=</span> <span class="nx">lipgloss</span><span class="p">.</span><span class="nf">NewStyle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span><span class="p">.</span><span class="nx">ShowLineNumbers</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">vp</span> <span class="o">:=</span> <span class="nx">viewport</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">vp</span><span class="p">.</span><span class="nf">SetContent</span><span class="p">(</span><span class="s">`Welcome to the chat room!
</span></span></span><span class="line"><span class="cl"><span class="s">Type a message and press Enter to send.`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ta</span><span class="p">.</span><span class="nx">KeyMap</span><span class="p">.</span><span class="nx">InsertNewline</span><span class="p">.</span><span class="nf">SetEnabled</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">model</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">textarea</span><span class="p">:</span>    <span class="nx">ta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">messages</span><span class="p">:</span>    <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">viewport</span><span class="p">:</span>    <span class="nx">vp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">senderStyle</span><span class="p">:</span> <span class="nx">lipgloss</span><span class="p">.</span><span class="nf">NewStyle</span><span class="p">().</span><span class="nf">Foreground</span><span class="p">(</span><span class="nx">lipgloss</span><span class="p">.</span><span class="nf">Color</span><span class="p">(</span><span class="s">&#34;5&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span><span class="p">:</span>         <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">model</span><span class="p">)</span> <span class="nf">Init</span><span class="p">()</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">Cmd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">Blink</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">model</span><span class="p">)</span> <span class="nf">Update</span><span class="p">(</span><span class="nx">msg</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span> <span class="p">(</span><span class="nx">tea</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tiCmd</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">Cmd</span>
</span></span><span class="line"><span class="cl">		<span class="nx">vpCmd</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">Cmd</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">m</span><span class="p">.</span><span class="nx">textarea</span><span class="p">,</span> <span class="nx">tiCmd</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">,</span> <span class="nx">vpCmd</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">WindowSizeMsg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nx">Width</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Width</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nf">SetWidth</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nx">Height</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Height</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nf">Height</span><span class="p">()</span> <span class="o">-</span> <span class="nx">lipgloss</span><span class="p">.</span><span class="nf">Height</span><span class="p">(</span><span class="nx">gap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">messages</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Wrap content before setting it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nf">SetContent</span><span class="p">(</span><span class="nx">lipgloss</span><span class="p">.</span><span class="nf">NewStyle</span><span class="p">().</span><span class="nf">Width</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nx">Width</span><span class="p">).</span><span class="nf">Render</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">messages</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nf">GotoBottom</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">KeyMsg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">KeyCtrlC</span><span class="p">,</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">KeyEsc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nf">Value</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">Quit</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">KeyEnter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">m</span><span class="p">.</span><span class="nx">messages</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">messages</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">senderStyle</span><span class="p">.</span><span class="nf">Render</span><span class="p">(</span><span class="s">&#34;You: &#34;</span><span class="p">)</span><span class="o">+</span><span class="nx">m</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nf">Value</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nf">SetContent</span><span class="p">(</span><span class="nx">lipgloss</span><span class="p">.</span><span class="nf">NewStyle</span><span class="p">().</span><span class="nf">Width</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nx">Width</span><span class="p">).</span><span class="nf">Render</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">messages</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">m</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nf">GotoBottom</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// We handle errors just like any other message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">case</span> <span class="nx">errMsg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">m</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">tea</span><span class="p">.</span><span class="nf">Batch</span><span class="p">(</span><span class="nx">tiCmd</span><span class="p">,</span> <span class="nx">vpCmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">model</span><span class="p">)</span> <span class="nf">View</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;%s%s%s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nf">View</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nf">View</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
それぞれの関数を簡単に説明する。</p>
<ul>
<li>
<p>main()</p>
<ul>
<li>bubbletea の初期化と実行</li>
</ul>
</li>
<li>
<p>initialModel()</p>
<ul>
<li>画面の要素 (viewport、 textarea) の構成</li>
</ul>
</li>
<li>
<p>Init()</p>
<ul>
<li>bubbletea から呼ばれるコールバック</li>
</ul>
</li>
<li>
<p>Update()</p>
<ul>
<li>何らかの更新イベント(例えばキー入力)があった際に呼ばれるコールバック</li>
</ul>
</li>
<li>
<p>View() </p>
<ul>
<li>コンソール上への出力処理。 bubbletea から呼ばれるコールバック。</li>
</ul>
</li>
</ul>
<p>
ということで、
基本的には bubbletea の初期化と bubbletea のコールバックで構成される。</p>
<p>
<strong>特に重要なのは、 initialModel と Update の処理になる。</strong> </p>
<p>
なお、 C-a, C-b 等の shell で良くあるキー操作は
bubbletea の textarea 内で処理してくれているので、特に追加で処理する必要はない。</p>
<p>
<strong>また、 View の処理も十分に理解しておく必要がある。</strong>
View の処理でコンソールに出力する文字列を確定しているので、
ここさえ変更すれば力技でどうにかなる。</p>
<p>
View の処理の 116 〜 121 行を見ると、
viewport と gap と textarea の情報から 
Sprintf をして文字列を作成していることが分かる。</p>
<p>
そして gap の宣言は 17 行目で、
次の通り単なる 改行コードが 2 つだけの文字列である。</p>
<pre class="example">
const gap = &#34;\n\n&#34;
</pre>
<p>
つまり、
 <strong>「View の処理は viewport の出力と textarea の出力に 改行 2 つを挟んだ結果が</strong>
<strong>コンソールに出力される」</strong> 
ということになる。</p>
<p>
この view の処理は、単純ではあるが非常に重要な処理であることが分かるだろう。</p>
<p>
なお、 このサンプルの gap は結構重要な役割をしている。
試しに View から gap を削除して実際に動かしてみると、
意図しない動きになることが分かるだろう。</p>
<div id="outline-container-headline-3" class="outline-4">
<h4 id="headline-3">
initialModel()
</h4>
<div id="outline-text-headline-3" class="outline-text-4">
<p>
initialModel() は、画面の要素の構成を定義する。</p>
<p>
ここでは、viewport と textarea を定義している。
なお、 bubbletea で利用できる CUI パーツはいくつかあるが、
具体的には以下で確認できる。</p>
<p>
&lt;<a href="https://github.com/charmbracelet/bubbles">https://github.com/charmbracelet/bubbles</a>&gt;</p>
<p>
この中から自分の用途にあったモノを選択する。</p>
<p>
なお、どれも用途に合わないのであれば、自分で定義することもできる。
が、今回のサンプルでは扱わない。</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-4">
<h4 id="headline-4">
Update()
</h4>
<div id="outline-text-headline-4" class="outline-text-4">
<p>
Update() は、何らかの更新イベント(例えばキー入力)があった際に呼ばれる。
そして、そのイベントを処理した結果を返す。</p>
<p>
なお、 initialModel() で定義した構成パーツのイベント処理は、
ここで呼び出す必要がある。 (80,81行目)</p>
<p>
他にも、イベントに対して独自に処理を追加する場合もここで処理を行なう。</p>
<p>
このサンプルでは Enter キー入力をトリガに、
textarea と viewport の制御として次を処理している。 (99行目)</p>
<ul>
<li>textarea に入力されていた文字列を取得</li>
<li>取得した文字列を viewport に追加</li>
<li>textarea の文字列をクリア</li>
<li>viewport を最終行にスクロール</li>
</ul>
<p>このように、 initialModel で定義した CUI パーツのイベント処理と、
独自のイベント処理を行なうのが Update の責務となる。</p>
<div id="outline-container-headline-5" class="outline-5">
<h5 id="headline-5">
viewport のイベント処理について
</h5>
<div id="outline-text-headline-5" class="outline-text-5">
<p>
サンプルでは viewport のイベント処理をそのまま呼び出しているが、
実は viewport は b, u, v キー入力で viewport のスクロール処理を
行なうようになっている。
つまり、 textarea で入力しているときに 
b, u, v を入力すると viewport が勝手にスクロールされてしまう。</p>
<p>
これだと使い勝手が悪いので、
キー入力のイベントは viewport の処理を外すなどした方が良い。</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
独自イベントの定義
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>
イベントを処理するのが Update() の責務だが、
独自にイベントを発生させたい時もある。
例えば周期タイマーでイベントを発生させたいなど。</p>
<p>
そういった、独自イベントを発生させる仕組みが tea.Cmd である。</p>
<p>
<code class="verbatim">tea.Cmd</code> の型は以下である。</p>
<pre class="example">
type Cmd func() Msg
</pre>
<p>
そして、 <code class="verbatim">tea.Msg</code> の型は以下である。</p>
<pre class="example">
type Msg interface{}
</pre>
<p>
つまり、何かイベントが発生した時に何らかの型の値を返すのが <code class="verbatim">tea.Cmd</code> になる。</p>
<p>
もうすこし具体的に例を挙げると、
次の関数は、ある chan からの入力を得たときに EventInfo を返す <code class="verbatim">tea.Cmd</code> を生成する。</p>
<div class="src src-go">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">EventInfo</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">detectChangeSession</span><span class="p">(</span> <span class="nx">event</span> <span class="kd">chan</span> <span class="kt">bool</span> <span class="p">)</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">Cmd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">tea</span><span class="p">.</span><span class="nx">Msg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;-</span><span class="nx">event</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">EventInfo</span><span class="p">(</span> <span class="kc">true</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
そして、この生成した tea.Cmd を Update() の戻り値として返してやると、
chan の入力を得た時に EventInfo を tea.Msg として引数に持つ Update() が呼ばれる。</p>
<p>
その tea.Msg を、次のように EventInfo の型で判定して処理を追加する。</p>
<div class="src src-go">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">switch</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="nx">EventInfo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// なにかの処理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
なお tea.Cmd は、 
tea.Batch() を使うと複数の tea.Cmd を繋げて 1 つの tea.Cmd とすることができる。</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-7" class="outline-2">
<h2 id="headline-7">
まとめ
</h2>
<div id="outline-text-headline-7" class="outline-text-2">
<p>
bubbletea を使うと、ちょっとリッチな CUI アプリを go で簡単に作れるので、
機会があれば試してみてほしい。</p>
</div>
</div>

		</div>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="ifritJP avatar" src="/blog2/public/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About ifritJP</span>
	</div>
	<div class="authorbox__description">
		生涯現役エンジニア
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/blog2/public/posts/2025/2025-10-05-rtx5000-rvc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">RTX5000 シリーズで RVC を動かす</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/blog2/public/posts/2025/2025-11-22-gemini3-videcoding/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Antigravity を使って Gemini3 で Vibe Coding をやってみた所感 (簡易資産シミュレーター)</p>
		</a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/dwarfjp" target="_blank">
				<svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
				<span>Twitter</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/ifritJP" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>

		
	</div>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/blog2/public/posts/2025/2025-11-22-gemini3-videcoding/">Antigravity を使って Gemini3 で Vibe Coding をやってみた所感 (簡易資産シミュレーター)</a></li>
			<li class="widget__item"><a class="widget__link" href="/blog2/public/posts/2025/2025-10-05-bubbletea/">go の bubbletea で簡易ターミナルエミュレータを作る</a></li>
			<li class="widget__item"><a class="widget__link" href="/blog2/public/posts/2025/2025-10-05-rtx5000-rvc/">RTX5000 シリーズで RVC を動かす</a></li>
			<li class="widget__item"><a class="widget__link" href="/blog2/public/posts/2025/2025-09-21-vibe-codig/">Vibe Coding をやってみた所感 (Go言語でのTCPフォワーダー開発事例)</a></li>
			<li class="widget__item"><a class="widget__link" href="/blog2/public/posts/2025/2025-09-16-moneybw-sbi/">マネーフォワードの SBI 証券連携の話</a></li>
		</ul>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2025 hoge blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/blog2/public/js/menu.js"></script>
</body>
</html>