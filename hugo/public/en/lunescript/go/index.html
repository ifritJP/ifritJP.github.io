<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>80. Transcompiling to Go Language - tech</title>
<meta name="generator" content="Hugo 0.118.2">
<link href="https://ifritjp.github.io/documentsindex.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="https://ifritjp.github.io/documents/en/lunescript/go/">
<link rel="stylesheet" href="https://ifritjp.github.io/documents/css/theme.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="https://ifritjp.github.io/documents/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<link rel="stylesheet" href="https://ifritjp.github.io/documents/css/custom.css">
<script src="https://ifritjp.github.io/documents/js/bundle.js"></script>
<script src="https://ifritjp.github.io/documents/js/lnsSrcRun.js"></script>
<script src="https://ifritjp.github.io/documents/js/highlight_lns.js"></script>
<link rel="stylesheet" href="https://ifritjp.github.io/documents/css/highlight_lns.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script><style>
:root {}
</style>
<meta property="og:title" content="80. Transcompiling to Go Language" />
<meta property="og:description" content="LuneScript can be transcompiled to Go as well as Lua as a transcompiled language. With this feature, LuneScript&#39;s self-hosting code is transcompiled into go language code and built with go to speed up LuneScript (approximately 16 times). See below for acceleration. https://ifritjp.github.io/blog2/public/posts/2021/2021-06-28-lunescript-build-time-2000/ However, since the support is limited to the functions required for LuneScript self-hosting, some functions are not supported. However, LuneScript&#39;s self-hosting itself uses most of LuneScript&#39;s features, so" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ifritjp.github.io/documents/en/lunescript/go/" /><meta property="article:section" content="LuneScript" />

<meta property="og:site_name" content="公開技術情報" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="80. Transcompiling to Go Language"/>
<meta name="twitter:description" content="LuneScript can be transcompiled to Go as well as Lua as a transcompiled language. With this feature, LuneScript&#39;s self-hosting code is transcompiled into go language code and built with go to speed up LuneScript (approximately 16 times). See below for acceleration. https://ifritjp.github.io/blog2/public/posts/2021/2021-06-28-lunescript-build-time-2000/ However, since the support is limited to the functions required for LuneScript self-hosting, some functions are not supported. However, LuneScript&#39;s self-hosting itself uses most of LuneScript&#39;s features, so"/>
<meta itemprop="name" content="80. Transcompiling to Go Language">
<meta itemprop="description" content="LuneScript can be transcompiled to Go as well as Lua as a transcompiled language. With this feature, LuneScript&#39;s self-hosting code is transcompiled into go language code and built with go to speed up LuneScript (approximately 16 times). See below for acceleration. https://ifritjp.github.io/blog2/public/posts/2021/2021-06-28-lunescript-build-time-2000/ However, since the support is limited to the functions required for LuneScript self-hosting, some functions are not supported. However, LuneScript&#39;s self-hosting itself uses most of LuneScript&#39;s features, so">

<meta itemprop="wordCount" content="1642">
<meta itemprop="keywords" content="" />
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4708B8S6ES"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4708B8S6ES');
</script>
</head>
<body><div class="container"><header>
<h1>tech</h1>


[<a href="https://ifritjp.github.io/documents/en/">English</a>]

[<a href="https://ifritjp.github.io/documents/">Japanese</a>]

</header>
<div class="global-menu">
<nav>
<ul>
<li><a href="/documents/">Home</a></li>
<li><a href="https://ifritjp.github.io/blog2/public/">blog</a></li>
<li><a href="https://ifritjp.github.io/LuneScript-webFront/lnsc_web_frontend/for_wasm/">LuneScript on Web</a></li></ul>
</nav>
</div>
<div class="content-container">
<main><h1>80. Transcompiling to Go Language</h1>

<p>
LuneScript can be transcompiled to Go as well as Lua as a transcompiled language.</p>
<p>
With this feature, LuneScript&#39;s self-hosting code is transcompiled into go language code and built with go to speed up LuneScript (approximately 16 times).</p>
<p>
See below for acceleration. <a href="https://ifritjp.github.io/blog2/public/posts/2021/2021-06-28-lunescript-build-time-2000/">https://ifritjp.github.io/blog2/public/posts/2021/2021-06-28-lunescript-build-time-2000/</a></p>
<p>
However, since the support is limited to the functions required for LuneScript self-hosting, some functions are not supported.</p>
<p>
However, LuneScript&#39;s self-hosting itself uses most of LuneScript&#39;s features, so it can handle normal usage without any problems.</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
How to transcompile to go language
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>
<strong>To transcompile to go language, by specifying -langGo at LuneScript command line option save or SAVE, output the transcompile result to go to a file with .go extension.</strong></p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Working with Lua
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
When transcompiling to the go language, you need to use special types when working with Lua.</p>
<p>
See below for details.</p>
<p>
<a href="../lua">../lua</a></p>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
Configuration after transcompiling to Go language
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>
LuneScript is a transcompiler to Lua, and has the advantage of being able to use Lua code directly from LuneScript.</p>
<p>
This feature is inherited even after transpiling to Go language.</p>
<p>
For example, the following code will work even after converting to Go language.</p>
<div class="src src-lns">
<pre tabindex="0"><code class="language-lns" data-lang="lns">// @lnsFront: ok
let step = 30;

// Lua のフィボナッチ関数
let code = ```
local function fib ( n )
   if n &lt; 2 then return n end
   return fib(n - 2) + fib(n - 1)
end
return fib
```;

// Lua コードのロード
form fibFunc( num:int ):int;
fn loadLua( txt:str ) : Luaval&lt;fibFunc&gt; {
   let fib;
   __luago {
      let loaded = unwrap _load( txt ## );
      fib = unwrap loaded(##);
   }
   return fib@@fibFunc;
}

// プロファイル用マクロ
macro _profile( exec:__exp ) {
   {}
   {
      let prev = os.clock();
      print( &#34;%s = %d: step = %d: time = %g&#34;
             (,,,,exec, ,,exec, step, os.clock() - prev ) );
   }
}

// Lua のコードをロードして実行
let fib_lua = loadLua( code );
__luago {
   _profile( fib_lua( step ) );
}

// LuneScript のフィボナッチ関数
fn fib_lns( num:int ) : int {
   if num &lt; 2 {
      return num;
   }
   return fib_lns( num - 2 ) + fib_lns( num - 1 );
}
// Go で定義した fib_lns 関数を実行
_profile( fib_lns( step ) );</code></pre>
</div>
<p>
This code does Fibonacci calculations with lua and LuneScript.</p>
<p>
The first code variable defines the lua code, the <code class="verbatim">loadLua()</code> function loads it, and the loaded Lua function is fib_lua. And the <code class="verbatim">fib_lns()</code> function in the second half is a LuneScript function that performs Fibonacci calculations.</p>
<div id="outline-container-headline-4" class="outline-3">
<h3 id="headline-4">
Transcompiled to Lua
</h3>
<div id="outline-text-headline-4" class="outline-text-3">
<p>
Transpiling the above code to Lua and running it will output:</p>
<div class="src src-txt">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">fib_lua( step ) = 24157817: step = 37: time = 5.69
</span></span><span class="line"><span class="cl">fib_lns( step ) = 24157817: step = 37: time = 5.38</span></span></code></pre></div>
</div>
<p>
This shows the calculation result and calculation time of <code class="verbatim">fib_lua()</code> and <code class="verbatim">fib_lns()</code> respectively.</p>
<p>
Looking at this, you can see that the execution time of function <code class="verbatim">fib_lua()</code> loaded by Lua and function <code class="verbatim">fib_lns()</code> of Lns takes almost the same time.</p>
<p>
This is a natural result. This is because when LuneScript is converted to Lua, <code class="verbatim">fib_lns()</code> written in LuneScript and <code class="verbatim">fib_lua()</code> written in Lua are almost the same Lua code.</p>
<p>
When the above code is transcompiled to Lua, the code looks like this:</p>
<div class="src src-lua">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">--miniGo.lns</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">_moduleObj</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">__mod__</span> <span class="o">=</span> <span class="s1">&#39;@miniGo&#39;</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">_lune</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span> <span class="s2">&#34;lune.base.runtime2&#34;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">if</span> <span class="ow">not</span> <span class="n">_lune2</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">   <span class="n">_lune2</span> <span class="o">=</span> <span class="n">_lune</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">37</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">code</span> <span class="o">=</span> <span class="s">[==[
</span></span></span><span class="line"><span class="cl"><span class="s">local function fib ( n )
</span></span></span><span class="line"><span class="cl"><span class="s">   if n &lt; 2 then return n end
</span></span></span><span class="line"><span class="cl"><span class="s">   return fib(n - 2) + fib(n - 1)
</span></span></span><span class="line"><span class="cl"><span class="s">end
</span></span></span><span class="line"><span class="cl"><span class="s">return fib
</span></span></span><span class="line"><span class="cl"><span class="s">]==]</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">loadLua</span><span class="p">(</span> <span class="n">txt</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="kd">local</span> <span class="n">loaded</span> <span class="o">=</span> <span class="n">_lune.unwrap</span><span class="p">(</span> <span class="n">_lune.loadstring52</span><span class="p">(</span> <span class="n">txt</span> <span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="kd">local</span> <span class="n">fib</span> <span class="o">=</span> <span class="n">_lune.unwrap</span><span class="p">(</span> <span class="n">loaded</span><span class="p">(</span>  <span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="kr">return</span> <span class="n">fib</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">fib_lua</span> <span class="o">=</span> <span class="n">loadLua</span><span class="p">(</span> <span class="n">code</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">   <span class="kd">local</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">os.clock</span><span class="p">(</span>  <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">print</span><span class="p">(</span> <span class="n">string.format</span><span class="p">(</span> <span class="s2">&#34;%s = %d: step = %d: time = %g&#34;</span><span class="p">,</span> <span class="s2">&#34;fib_lua( step )&#34;</span><span class="p">,</span> <span class="n">fib_lua</span><span class="p">(</span> <span class="n">step</span> <span class="p">),</span> <span class="n">step</span><span class="p">,</span> <span class="n">os.clock</span><span class="p">(</span>  <span class="p">)</span> <span class="o">-</span> <span class="n">prev</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">fib_lns</span><span class="p">(</span> <span class="n">num</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="kr">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="n">num</span>
</span></span><span class="line"><span class="cl">   <span class="kr">end</span>
</span></span><span class="line"><span class="cl">   <span class="kr">return</span> <span class="n">fib_lns</span><span class="p">(</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">+</span> <span class="n">fib_lns</span><span class="p">(</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">   <span class="kd">local</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">os.clock</span><span class="p">(</span>  <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">print</span><span class="p">(</span> <span class="n">string.format</span><span class="p">(</span> <span class="s2">&#34;%s = %d: step = %d: time = %g&#34;</span><span class="p">,</span> <span class="s2">&#34;fib_lns( step )&#34;</span><span class="p">,</span> <span class="n">fib_lns</span><span class="p">(</span> <span class="n">step</span> <span class="p">),</span> <span class="n">step</span><span class="p">,</span> <span class="n">os.clock</span><span class="p">(</span>  <span class="p">)</span> <span class="o">-</span> <span class="n">prev</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">return</span> <span class="n">_moduleObj</span></span></span></code></pre></div>
</div>
<p>
Here&#39;s an excerpt from the notable <code class="verbatim">fib_lns()</code> function definition:</p>
<div class="src src-lua">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">fib_lns</span><span class="p">(</span> <span class="n">num</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="kr">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="n">num</span>
</span></span><span class="line"><span class="cl">   <span class="kr">end</span>
</span></span><span class="line"><span class="cl">   <span class="kr">return</span> <span class="n">fib_lns</span><span class="p">(</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">+</span> <span class="n">fib_lns</span><span class="p">(</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span></span></span></code></pre></div>
</div>
<p>
As you can see, <code class="verbatim">fib_lns()</code> and <code class="verbatim">fib_lub()</code> have equivalent code.</p>
<p>
So it&#39;s no surprise that <code class="verbatim">fib_lns()</code> and <code class="verbatim">fib_lua()</code> take about the same amount of time.</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
When transcompiled to go
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<p>
On the other hand, when transpiling to go , the execution result is:</p>
<div class="src src-txt">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">fib_lua( step ) = 24157817: step = 37: time = 6.07
</span></span><span class="line"><span class="cl">fib_lns( step ) = 24157817: step = 37: time = 0.34</span></span></code></pre></div>
</div>
<p>
<strong>You can see that <code class="verbatim">fib_lns()</code> takes about 1/18 less time than <code class="verbatim">fib_lua()</code>.</strong></p>
<p>
Here is the result of transcompiling to go:</p>
<div class="src src-go">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// This code is transcompiled by LuneScript.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">lnsc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">.</span> <span class="s">&#34;lnsc/lune/base/runtime_go&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">init_miniGo</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">miniGo__mod__</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">miniGo_step</span> <span class="nx">LnsInt</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">miniGo_code</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">miniGo_fib_lua</span> <span class="o">*</span><span class="nx">Lns_luaValue</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">miniGo_fibFunc_1003_</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">arg1</span> <span class="nx">LnsInt</span><span class="p">)</span> <span class="nx">LnsInt</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 14: decl @miniGo.loadLua
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">miniGo_loadLua_1009_</span><span class="p">(</span><span class="nx">txt</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Lns_luaValue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">loaded</span> <span class="o">*</span><span class="nx">Lns_luaValue</span>
</span></span><span class="line"><span class="cl">    <span class="nx">loaded</span> <span class="p">=</span> <span class="nf">Lns_unwrap</span><span class="p">(</span> <span class="nf">Lns_car</span><span class="p">(</span><span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">Load</span><span class="p">(</span><span class="nx">txt</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))).(</span><span class="o">*</span><span class="nx">Lns_luaValue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">fib</span> <span class="nx">LnsAny</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fib</span> <span class="p">=</span> <span class="nf">Lns_unwrap</span><span class="p">(</span> <span class="nf">Lns_car</span><span class="p">(</span><span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">RunLoadedfunc</span><span class="p">(</span><span class="nx">loaded</span><span class="p">,</span><span class="nf">Lns_2DDD</span><span class="p">([]</span><span class="nx">LnsAny</span><span class="p">{}))[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fib</span><span class="p">.(</span><span class="o">*</span><span class="nx">Lns_luaValue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 36: decl @miniGo.fib_lns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">miniGo_fib_lns_1025_</span><span class="p">(</span><span class="nx">num</span> <span class="nx">LnsInt</span><span class="p">)</span> <span class="nx">LnsInt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">num</span> <span class="p">&lt;</span> <span class="mi">2</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">num</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">miniGo_fib_lns_1025_</span><span class="p">(</span><span class="nx">num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">miniGo_fib_lns_1025_</span><span class="p">(</span><span class="nx">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Lns_miniGo_init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">init_miniGo</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">init_miniGo</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="nx">miniGo__mod__</span> <span class="p">=</span> <span class="s">&#34;@miniGo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Lns_InitMod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">miniGo_step</span> <span class="p">=</span> <span class="mi">37</span>
</span></span><span class="line"><span class="cl">    <span class="nx">miniGo_code</span> <span class="p">=</span> <span class="s">&#34;local function fib ( n )   if n &lt; 2 then return n end   return fib(n - 2) + fib(n - 1)endreturn fib&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">miniGo_fib_lua</span> <span class="p">=</span> <span class="nf">miniGo_loadLua_1009_</span><span class="p">(</span><span class="nx">miniGo_code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">prev</span> <span class="nx">LnsReal</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prev</span> <span class="p">=</span> <span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">OS_clock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Lns_print</span><span class="p">([]</span><span class="nx">LnsAny</span><span class="p">{</span><span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">String_format</span><span class="p">(</span><span class="s">&#34;%s = %d: step = %d: time = %g&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nx">LnsAny</span><span class="p">{</span><span class="s">&#34;fib_lua( step )&#34;</span><span class="p">,</span> <span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">RunLoadedfunc</span><span class="p">(</span><span class="nx">miniGo_fib_lua</span><span class="p">,</span><span class="nf">Lns_2DDD</span><span class="p">(</span><span class="nx">miniGo_step</span><span class="p">))[</span><span class="mi">0</span><span class="p">].(</span><span class="nx">LnsInt</span><span class="p">),</span> <span class="nx">miniGo_step</span><span class="p">,</span> <span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">OS_clock</span><span class="p">()</span> <span class="o">-</span> <span class="nx">prev</span><span class="p">})})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">prev</span> <span class="nx">LnsReal</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prev</span> <span class="p">=</span> <span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">OS_clock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Lns_print</span><span class="p">([]</span><span class="nx">LnsAny</span><span class="p">{</span><span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">String_format</span><span class="p">(</span><span class="s">&#34;%s = %d: step = %d: time = %g&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nx">LnsAny</span><span class="p">{</span><span class="s">&#34;fib_lns( step )&#34;</span><span class="p">,</span> <span class="nf">miniGo_fib_lns_1025_</span><span class="p">(</span><span class="nx">miniGo_step</span><span class="p">),</span> <span class="nx">miniGo_step</span><span class="p">,</span> <span class="nf">Lns_getVM</span><span class="p">().</span><span class="nf">OS_clock</span><span class="p">()</span> <span class="o">-</span> <span class="nx">prev</span><span class="p">})})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">init_miniGo</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
Since it is very difficult to read, the definition part of the <code class="verbatim">fib_lns()</code> function is extracted as follows.</p>
<div class="src src-go">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">miniGo_fib_lns_1025_</span><span class="p">(</span><span class="nx">num</span> <span class="nx">LnsInt</span><span class="p">)</span> <span class="nx">LnsInt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">num</span> <span class="p">&lt;</span> <span class="mi">2</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">num</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">miniGo_fib_lns_1025_</span><span class="p">(</span><span class="nx">num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">miniGo_fib_lns_1025_</span><span class="p">(</span><span class="nx">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
Although the function name is long, you can see that the LuneScript code is converted to go as it is. When executing a function, just call the function normally as follows.</p>
<pre class="example">
 miniGo_fib_lns_1025_(miniGo_step)
</pre>
<p>
On the other hand, Lua&#39;s <code class="verbatim">fib_lua()</code> function is loaded by <code class="verbatim">miniGo_fib_lua = miniGo_loadLua_1009_(miniGo_code)</code> with a function for executing Lua code, and when executing it, the function is called as follows.</p>
<pre class="example">
Lns_getVM().RunLoadedfunc(miniGo_fib_lua,Lns_2DDD(miniGo_step))
</pre>
<p>
As you can see, <code class="verbatim">fib_lns()</code> and <code class="verbatim">fib_lua()</code> are completely different.</p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
build
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>
The following steps are required to transcompile and build to go.</p>
<ul>
<li>Generate go.mod</li>
<li>Register the LuneScript runtime with go.mod</li>
<li>Generate main.go</li>
<li>Generate .go from .lns</li>
<li>Update go.mod</li>
<li>go build</li>
</ul>
<p>If you have updated .lns, repeat the process starting with &#34;Generate .go from .lns&#34;.</p>
<p>
I will explain each step.</p>
<div id="outline-container-headline-7" class="outline-4">
<h4 id="headline-7">
Generate go.mod
</h4>
<div id="outline-text-headline-7" class="outline-text-4">
<p>
Execute the following command in the directory where lune.js is located.</p>
<pre class="example">
$ go mod init test # &lt;--- test は環境に合せて指定してください
</pre>
</div>
</div>
<div id="outline-container-headline-8" class="outline-4">
<h4 id="headline-8">
Register the LuneScript runtime with go.mod
</h4>
<div id="outline-text-headline-8" class="outline-text-4">
<p>
Register the LuneScript runtime in go.mod with the following command.</p>
<pre class="example">
$ go get github.com/ifritJP/LuneScript/src@latest
</pre>
<p>
You&#39;ll run go mod tidy in the following steps, but be sure to run go get first.</p>
</div>
</div>
<div id="outline-container-headline-9" class="outline-4">
<h4 id="headline-9">
Generate main.go
</h4>
<div id="outline-text-headline-9" class="outline-text-4">
<p>
go requires the entry function <code class="verbatim">main()</code>.</p>
<p>
The following command generates main.go which defines the <code class="verbatim">main()</code> function of go.</p>
<pre class="example">
$ lnsc hoge.lns mkmain main.go
</pre>
<p>
where hoge.lns specifies the main module which defines __main in lns. main.go specifies the output path.</p>
<p>
A module that defines a __main function is required when transpiling to go.</p>
<p>
The main.go generated by this command contains code to initialize the lns runtime.</p>
</div>
</div>
<div id="outline-container-headline-10" class="outline-4">
<h4 id="headline-10">
Generate .go from .lns
</h4>
<div id="outline-text-headline-10" class="outline-text-4">
<p>
Generate .go with the following command.</p>
<pre class="example">
$ lnsc hoge.lns save -langGo
</pre>
<p>
If the main module contains the __main function, add the –main option.</p>
<pre class="example">
$ lnsc hoge.lns save -langGo --main hoge
</pre>
<p>
where hoge in –main hoge is the import path of the main module.</p>
<p>
For example, if your main module is foo/bar/hoge.lns,</p>
<pre class="example">
$ lnsc foo/bar/hoge.lns save -langGo --main foo.bar.hoge
</pre>
<p>
becomes.</p>
<p>
A __main function is required when transcompiling LuneScript to go.</p>
</div>
</div>
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
Update go.mod
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<p>
Update go.mod with the following command.</p>
<pre class="example">
$ go mod tidy
</pre>
</div>
</div>
<div id="outline-container-headline-12" class="outline-4">
<h4 id="headline-12">
go build
</h4>
<div id="outline-text-headline-12" class="outline-text-4">
<p>
After converting all lns files and generating main.go, run go build.</p>
<pre class="example">
$ go build
</pre>
<p>
<strong>If the above gives an error, try the following.</strong></p>
<pre class="example">
$ go build -tags gopherlua
</pre>
<p>
This will build the transcompiled module in go.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-3">
<h3 id="headline-13">
Need to link Lua library after transcompiling to go
</h3>
<div id="outline-text-headline-13" class="outline-text-3">
<blockquote>
<p>追記</p>
<p>
<strong>Lua ライブラリのリンクを回避する方法を用意しました。</strong></p>
<p>
<a href="../lua_runtime">../lua_runtime</a></p>
</blockquote>
<p>
As mentioned above, LuneScript works closely with Lua. And even after transcompiling to go, it still supports that interaction.</p>
<p>
In order for this interaction to work, the code transcompiled to go needs the lua VM to do the lua work.</p>
<p>
To be more precise, in addition to this interaction with Lua, LuneScript also has operations that require the Lua VM. Specifically, Lua VM is used for processing macro expansion and processing some built-in functions.</p>
<p>
<strong>That lua VM assumes the official lua-5.3.4 and links liblua5.3.so .</strong></p>
<p>
The go language has the advantage of being able to generate a single, environment-independent executable, but unfortunately transcompiling LuneScript to go requires linking to liblua5.3.so .</p>
<p>
Note that not only liblua5.3.so is required at runtime, but also include files for lua-5.3.4 are required at build time.</p>
</div>
</div>
</div>
</div>
<div class="edit-meta">

<br></div><nav class="pagination"><a class="nav nav-prev-2" href="https://ifritjp.github.io/documents/en/lunescript/dir/" title="29. Recommended directory structure for projects using LuneScript"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - 29. Recommended directory structure for projects using LuneScript</a>
<a class="nav nav-next-2" href="https://ifritjp.github.io/documents/en/lunescript/go_package/" title="80.2 Packages when transpiling to Go">Next - 80.2 Packages when transpiling to Go <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav><footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://themes.gohugo.io/hugo-theme-techdoc/">TechDoc</a>. Designed by <a href="https://github.com/thingsym/hugo-theme-techdoc">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">

<nav class="slide-menu">
<ul>
<li class=""><a href="https://ifritjp.github.io/documents">Home</a></li>

<li class="parent has-sub-menu"><a href="https://ifritjp.github.io/documents/en/lunescript/">Easier Lua development with the transcompiler LuneScript!!<span class="mark opened">-</span></a>
  
<ul class="sub-menu">
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/tutorial2.setup/">01. Introduction</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/tutorial3.hello/">02. Hello world</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/crosscompile/">03. Cross-compiling between Lua versions</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/value/">04. Values</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/set/">04.2. Set</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/tuple/">04.3 Tuples</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/enum/">05. enum</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/match/">06. match</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/variable/">07. Variables</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/branch/">08. General branch syntax</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/loop/">09. Repetition Syntax</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/func/">10. Functions</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/multipleretval/">10.2. Multi-value return values</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/defaultarg/">10.3. Omitting Arguments</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/arg/">10.4. Variadic Arguments and Return Values</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/closure/">10.5. Closures</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/error/">10.6. Error handling</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/nilable/">11. nilable</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/class1/">12. Class basics</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/class2accessor/">13. accessor</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/classinherit/">14. Class Inheritance</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/classadvertise/">15. Class advertise</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/classoverride/">16. Class override</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/interface/">17. Interface</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/classmapping/">18. mapping</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/generics/">19. generics</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/generics-go/">19.2. generics (two collection types)</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/nilcond/">20. nil conditional operator</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/import/">21. import/provide</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/require/">22. require/module</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/glue/">22.1. Semi-automatic generation of glue code</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/lua/">22.2. Linking with Lua</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/make/">23. Build</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/macro/">24. Macro</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/cast/">25. Cast</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/subfile/">26. subfile</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/lazyloading/">27. Lazy Loading</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/shebang_main/">28. shebang and command line arguments</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/dir/">29. Recommended directory structure for projects using LuneScript</a></li>
<li class="active"><a href="https://ifritjp.github.io/documents/en/lunescript/go/">80. Transcompiling to Go Language</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/go_package/">80.2 Packages when transpiling to Go</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/go_wasm/">80.4 WebAssembly support for LuneScript</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/async/">81. Safe Asynchronous Processing</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/async_old/">81.1 Asynchronous processing (past information)</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/luago/">82. Linking with Lua</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/ebnf/">A. BNF</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/onweb/">A. LuneScript running on a web browser</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/reason/">A. Reason for developing Lua transcompiler LuneScript</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/recommend/">A. Recommendations for transcompiler development</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/lnstags/">A. Tag jumping with lnstags (source code tagging system)</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/completion/">A.Let&#39;s have more fun in a modern development environment</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/box/">Box edition</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/lua_runtime/">Lua runtime when transpiling to 80.3 Go</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/test/">X. The Importance of Self-Hosting and Test Design in Language Development Quality Control</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/design/">Y.1 How to develop LuneScript</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/design-2/">Y.2 Development of LuneScript (type information management)</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/design-3/">Y.3 LuneScript Development (Scopes and Symbols)</a></li>
<li class=""><a href="https://ifritjp.github.io/documents/en/lunescript/go_study/">Z. Transcompile to Go language (exploratory stage)</a></li>
</ul>
  
</li>
</ul>
</nav>



<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>
